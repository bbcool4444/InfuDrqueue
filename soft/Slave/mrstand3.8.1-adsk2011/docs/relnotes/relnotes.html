<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <style type="text/css">
body 
{
    padding: 2em 1em 2em 1em;
    margin: 1em 1em 1em 1em;
    font-family: arial, sans-serif;
    color: black;
    background-color: white;
}
h1 { text-align: center; margin-top: 1em; margin-bottom: 1em;}
p { margin-top: 0.6em; margin-bottom: 0.6em;  }
ul { margin-bottom: 1em; }
li { margin: 1em 0.5em 1em -0.5em; }
code { color:#722 }
em { margin: 0 0.3em }
*.copyright {font-size: 80%; }
.note, div.toc
{
    margin: 3ex 0em 4ex 0em;
    padding: 0.5ex 2em 1ex 2em;
    background: rgb(240,240,240);
}
div.toc h3, div.toc dl { margin-top: 1ex; margin-bottom: 1ex; } 
a { text-decoration: none; }
a:hover { text-decoration: underline; }</style>
  <title>mental ray Release Notes</title>
</head>

<body>
<h1>mental ray Release Notes</h1>

<p><b>Version 3.8.1.28</b></p>

<p><b>Mar 12, 2010</b></p>

<p><a href="#copyright">Copyright</a> &copy; 1986-2010 mental images GmbH,
Berlin</p>

<div class="toc">
<h3>Contents</h3>
<dl>
  <dt><a href="#introduction">Introduction</a></dt>
  <dt><a href="#changes">Changes by Version</a></dt>
  <dt><a href="#openexr">Support for OpenEXR</a></dt>
</dl>
</div>

<h2 id="introduction">Introduction</h2>

<p>These release notes list changes in mental ray since version 3.7.1.1.</p>

<h2 id="changes">Changes by Version</h2>

<div class="note">
<p><b>Note:</b> Version 3.8 and later versions of mental ray are binary
incompatible with mental ray versions 3.7.x and prior. Partial compatibility
with 3.7 is maintained.</p>
<ul>
  <li>Some shaders compiled for previous versions may need recompilation to
    be used with this version. This specifically applies for the MetaSL
    generated shaders.</li>
  <li>Version 3.8 cannot be combined with version 3.7.x and earlier versions
    in network rendering. </li>
</ul>
</div>

<h3>Changes in version 3.8.1.28</h3>

<p>Adjusted tapes for OEM releases.</p>

<h3>Changes in version 3.8.1.27</h3>

<p>For mental ray standalone executables and integration libraries protected
my SPM, switch the license counting to 1 license per machine. This is more
generous than 1 license per 4 threads used since version 3.8.1.16.</p>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For scenes using multiple assemblies, fixed rare race condition leading
    to null tag access fatal.</li>
  <li>For material phenomena with no surface shader, attach bsdf (if any) to
    the surface slot.</li>
</ul>

<h3>Changes in version 3.8.1.26</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed finalgather preview rendering with color profiles.</li>
  <li>For subdivision surfaces, fixed echo of derivatives and length
    approximations.</li>
  <li>For subdivision surfaces (<code>ccmesh</code> implementation), fixed a
    crash observed for some objects.</li>
  <li>For the BSP2 acceleration, fixed a memory leak with assemblies and
    multiple instances.</li>
  <li>For the BSP2 acceleration, fixed a performance regression.</li>
  <li>For geometry approximation, fixed a crash due to uninitialized
  memory.</li>
</ul>

<h3>Changes in version 3.8.1.25</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible missing hair artifacts for scenes with multiple hair
    objects some of which have no hairs. This completes empty hair object
    file in version 3.8.1.24.</li>
  <li>Fixed possible crack artifacts if BSP2 acceleration was used.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Fixed a crash in the lume <code>Glare</code> output shader.</li>
</ul>

<h3>Changes in version 3.8.1.24</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash if photon map (<code>globillum</code> or
    <code>caustic</code>) was used in a scene with assemblies.</li>
  <li>Fixed a crash if a hair object with no hairs is rendered. Known issue:
    in this version, such object may lead to missing hair parts if there
    several hair objects in the scene (fixed in 3.8.1.25).</li>
  <li>MetaSL compiler language version was not bumped to 1.1, fixed.</li>
</ul>

<h3>Changes in version 3.8.1.23</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Following customer requests, the default value for per-framebuffer
    <code>premultiplied</code> flag introduced in version 3.8.0.8 has been
    changed to maintain compatibility with mental ray 3.7+ and prior. For the
    primary framebuffer, the default value is <code>true</code>. For user
    color framebuffer, the default value is <code>false</code>. The flag is
    effective for rasterizer mode only.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed loading of textures of the <code>rgbe</code> type (in particular,
    .hdr images). If a color profile has been specified in the scene, the
    loaded images were black.</li>
  <li>For hair ray tracing, <code>state-&gt;bary[0]</code> sometimes was
    initialized to NaN value, fixed.</li>
  <li>Fixed rendering speed regression if BSP2 acceleration used for scenes
    with builtin IBL.</li>
  <li>For MetaSL Illumination node shaders, removed deprecated "compile as
    bsdf" annotation. In particular, this fixes internal shader declaration
    generated for these shaders.</li>
</ul>

<h3>Changes in version 3.8.1.22</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For <code>ccmesh</code> objects, fixed echo of derivatives and length
    approximations.</li>
  <li>Fixed a crash in case of incremental change for a camera stereo mode
    (on/off).</li>
  <li>Fixed possible segmentation fault at mental ray exit if rendering of
    scenes with assemblies was used. Regression in version 3.8.1.20.</li>
  <li>The <code>"output off"</code> option and command line option disabled
    the file output statement together with calling of output shaders.
  Fixed.</li>
  <li>Fixed a crash if ambient occlusion with caching was used in combination
    with contour rendering.</li>
  <li>Fixed a crash in output of multiple framebuffers into the same OpenEXR
    file for scenes with more than 6 user framebuffers rendered.</li>
  <li>Fixed possible too high capacities (bit per pixel, alpha) used in the
    main color framebuffer file for scenes with more than 6 user framebuffers
    rendered. In particular, <code>rgba</code> primary framebuffer could be
    advanced to <code>rgba_16</code> without a need to do so, consuming more
    memory.</li>
  <li>For MetaSL LLVM backend, fixed bytecode generation for shaders with
    array of structs parameters.</li>
  <li>For MetaSL LLVM backend, fixed runtime crash due to calling generated
    destructors at improper time.</li>
  <li>For MetaSL LLVM backend, fixed wrong code generation for swizzles and
    for the ternary ( <code>"? :"</code> ) operator.</li>
</ul>

<p></p>

<h3>Changes in version 3.8.1.21</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a minor memory leak if BSP2 acceleration was used.</li>
  <li>Calling <code>mi_output_image_open()</code> function with out-of-range
    framebuffer index could cause an unknown tag access fatal or crash.
    Fixed, an error message is printed.</li>
  <li>When rasterizer was used with very low shutter times (0.0001), the
    scene was rendered black. Fixed.</li>
  <li>Fixed possible artifacts in glossy components of built-in BRDFs and
    MetaSL shaders based on BRDFs. Scenes using C/C++ shaders are not
    affected.</li>
  <li>Fixed possible crash in filtered texture lookup.</li>
</ul>

<p></p>

<h3>Changes in version 3.8.1.20</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For <strong>iray</strong>, fixed rendering of the GPUs with CUDA 1.0
    compute capability is fixed. Regression in the previous version.</li>
  <li>For mental ray integrations, fixed a race condition which could lead to
    a crash in aborted photon emission.</li>
  <li>Fixes possible self-intersection artifacts in the build-in ambient
    occlusion.</li>
  <li>Do not apply gamma correction for images of <code>half</code> type, so
    that <code>half</code> and <code>float</code> images are handled
    consistently.</li>
  <li>Fixed ray differential initialization in finalgather precomputation
    stage. Also fixed normalization of ray differentials in reflections.</li>
  <li>Fixed major memory and database tag leaks for scenes with assemblies.
    Shader instances defined inside of assemblies were not deleted together
    with assembly.</li>
  <li>Fixed a memory and database tag leak in multihosted rendering. For
    geometry tessellation jobs executed on slave hosts, the parameter tags
    were not deleted. Tessellation is likely to be executed on slave hosts
    for scenes with finalgather.</li>
  <li>For IBL (image based lighting), fixed possible NaN pixel colors if the
    <code>"environment lighting shadow"</code> modes <code>"solid"</code> or
    <code>"off"</code> were used.</li>
  <li>Fixed possible assertion and crash when a light profile is deleted.</li>
  <li>For the debug version of mental ray, fixed possible wrong assertion for
    scenes with multiple diffuse refraction bounces.</li>
  <li>For paint.dll shader library on Windows platforms, copyright/version
    information was not included. Fixed.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the architectural material shader, fixed Exact AO feature.
    Regression from mental ray 3.7+.</li>
</ul>

<h3>Changes in version 3.8.1.19</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For <strong>iray</strong>, firefly handling is improved.</li>
  <li>For <strong>iray</strong>, glossy transmission and glossy reflection
    are better mapped to mia_materials rendered by the mental ray software
    renderer.</li>
  <li>For <strong>iray</strong>, full 16bit alpha channel support is
  provided.</li>
  <li>For <strong>iray</strong>, better support for quality termination
    parameter and the (optional) post filter is provided. </li>
  <li>For <strong>iray</strong>, a multi-layer blend map in the iray core is
    now supported. It includes two layers and two blend modes, which can be
    extended if necessary. The blend map is able to have one level of nested
    map - and the nested maps cannot be blend maps (no recursive calls are
    allowed). </li>
  <li>For <strong>iray </strong>, reduced memory usage for bump mapping and
    frame buffers.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed an artifact on triangle edges that occurred when using bsp2.</li>
  <li>Fixed a clipping artifact when using bsp2.</li>
  <li>For MetaSL shaders, fixed regression where shader state inputs were
    being ignored.</li>
  <li>For iray prevent crash if iray plugin was not loaded.</li>
  <li>Added traversal callback functionality for assemblies.</li>
</ul>

<h3>Changes in version 3.8.1.18</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For <strong>iray</strong>, finish the separation of iray related
    functionality out of mental ray into the external libraries
    <code>libiraymr</code> and <code>libiray</code>. The libraries are loaded
    automatically by mental ray as soon as iray rendering is enabled, and
    searched for along the regular library search path.</li>
  <li>For <strong>iray</strong>, enable support for CUDA compute capabilities
    1.0 in addition to compute capabilities 1.1. This allows to render with
    iray even on first generation of CUDA-enabled GPUs, but may take up to 20
    percent more time to finish. </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For raylib integration, expose functionality to convert color profiles
    from the internal color profiles to a specified color profile. </li>
  <li>Fixed a crash that occurred with phenomena declarations in
  assemblies.</li>
  <li>Fixed a crash for irradiance particles when increasing the IP indirect
    passes between frames.</li>
  <li>Fixed a crash in imf_disp that occurred when changing the camera
    resolution or switching stereo mode on incrementally.</li>
  <li>Fixed imf_disp with command line option <code>--disable-gl</code>
  set.</li>
</ul>

<h3>Changes in version 3.8.1.17</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For <strong>iray</strong>, shader mapping functionality and component
    of mental ray connectivity has been moved from mental ray
    standalone/raylib to a separate dynamic library,
    <code>libiraymr.so/.dll/.dylib</code>. This library is distributed
    together with iraylib and is installed at the same location.</li>
  <li>For MetaSL compiler, improved compiler error file/line reporting.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed another crash for BSP2 acceleration for scenes with motion blur
    containing both moving and static objects. The fix in version 3.8.1.16
    was incomplete.</li>
  <li>For the BSP2 acceleration used for motion blur scene, fixed possible
    improper selection of splitting planes, which could lead to memory
    consumption inefficiency.</li>
  <li>For MetaSL LLVM backend, fixed code generation for enums.</li>
  <li>For MetaSL compiler, fixed search path for the import statements.</li>
  <li>For MetaSL compiler, fixed texture comparison operators.</li>
</ul>

<h3>Changes in version 3.8.1.16</h3>

<p>For SPM-protected mental ray <em>licensed by mental images,</em>
simplified the licensing scheme.</p>

<p>One license per 4 cores on a machine is requested. </p>

<p>In particular this new scheme provides a fair license counting on virtual
machines, which was not possible to achieve with the per-CPU-socket scheme
used before.</p>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash for BSP2 acceleration for scenes scenes with motion blur
    containing both moving and static objects.</li>
  <li>When mental ray is low on memory, fixed possible segmentation fault
    crashes for shaders using <code>mi_tri_vectors()</code> function. The
    list of such shaders includes architectural material, subsurface
    scattering shaders, and many common OEM shaders. 
    <p>The validity scope of <code>mi_tri_vectors()</code> function is
    adjusted. The returned pointers are valid until the <strong>next
    call</strong> to that function for a given rendering tile/task. In
    particular, shaders may need to be adjusted to copy the results before
    evaluating shader parameters (mi_eval), tracing rays and calling other
    functions which would lead to execution of other shaders. In earlier
    versions of mental ray, the validity scope of the data returned by
    pointer was not specified and could be extremely short when mental ray
    was low on memory.</p>
  </li>
  <li>When mental ray is low on memory, fixed possible rare unknown database
    tag access fatal (rare race condition).</li>
  <li>For <code>mi_api_add_shader()</code> function, check if the new tag for
    the given name is the same as the old one, and issue an error in this
    case. The usage is illegal as this function is unfenced to delete the old
    tag.</li>
  <li>In debug version of mental ray, suppress messages from the ZLIB
    library, used in particular in (de)compression of some of OpenEXR
  images.</li>
</ul>

<h3>Changes in version 3.8.1.15</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed MetaSL LLVM backend crash on Windows XP machines.</li>
  <li>For MetaSL LLVM backend, the default optimization level of LLVM is set
    to zero. The optimizer in LLVM 2.5 JIT compiler has been observed to
    produce illegal code in some case.</li>
</ul>

<h3>Changes in version 3.8.1.14</h3>

<p>Summarized release notes for iray are provided in a separate <a
href="irayrelnotes.pdf">document</a>.</p>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>MetaSL shaders are compiled on demand shortly before first call (LLVM
    backend or C++ backend with C++ external compiler invocation part of the
    compilation process). On multi-CPU machines this allows parallel
    compilation of several shaders. 
    <p>In earlier versions, compilation was triggered by scene preprocessing
    and was done sequentially.</p>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>On MacOSX platform, fixed mental ray crash if LLVM backend is used.</li>
  <li>For rendering of hairs in combination with motion blur, fixed possible
    segmentation crashes, missing axis-aligned hair parts and possible
    performance drop.</li>
  <li>Changed the way shader declarations are re-created. 
    <ul>
      <li>If shader declaration is derived from MetaSL shader, the tag is not
        changed, only its content does.</li>
      <li>Re-declarations of shades inside of <em>assemblies</em> are
        ignored, this restores mental ray 3.7+ behavior.</li>
    </ul>
    <p>Together, this fixes issue with deleting shader declarations for
    existing shaders.</p>
  </li>
  <li>For Map containers, remove temporary files properly.</li>
  <li>In multihosted rendering, removed redundant error message.</li>
  <li>Fixed mental ray unknown tag fatal in erroneous situation when a shader
    declaration (or SL shader) MetaSL shader) has been deleted while some of
    the shader instances are still present in the database.</li>
  <li>Fixed possible crash when MetaSL shaders or phenomena were
    incrementally changed.</li>
  <li>For MetaSL compiler, fixed compilation of type names contain
  semicolons.</li>
  <li>For MetaSL C++ and LLVM backends, pass input parameters to shader
    constructors and destructors.</li>
  <li>For MetaSL C++ backend, fixed compilation of scalar and vector texture
    samplers, as well as cube texture samplers. Regression in version
  3.8.1.8.</li>
  <li>For the <code>imf_disp</code> tool, possible wrong image display after
    window resizing.</li>
</ul>

<h3>Changes in version 3.8.1.13</h3>

<p><strong>Known issues in this version: </strong></p>
<ul>
  <li>On MacOSX platform, mental ray will crash if LLVM backend is used
    (since version 3.8.1.8). Fixed in 3.8.1.14.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Removed undocumented and unneeded <code>mi_phen_clone/unclone</code>
    functions.</li>
  <li>For mental ray standalone, fixed a regression in command line parsing
    which may lead to a crash.</li>
  <li>Texture pyramid fix in version 3.8.1.12 was incorrect, a proper fix is
    added.</li>
  <li>For MetaSL shaders, fixed builtin bsdf names according to the MetaSL
    spec.</li>
</ul>

<h3>Changes in version 3.8.1.12</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash if a texture with on-demand-created filtering pyramids is
    loaded twice.</li>
  <li>For MetaSL compiler, fixed a regressing in parser. The
    <code>#define</code>'s values wrapped by ()-brackets are parsed correctly
    now.</li>
  <li>For MetaSL compiler, fixed conversion of integer vector parameters.</li>
  <li>For MetaSL compiler, allow arbitrary const expressions for array
  size.</li>
  <li>For MetaSL compiler, fixed improper handling of const and uniform
    attributes for constructor calls.</li>
  <li>For mental ray used as a MetaSL standalone compiler (ray -mslc command
    line option), fixed compilation of BSDF shaders into C++ code.</li>
</ul>

<h3>Changes in version 3.8.1.11</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added support for MetaSL material phenomena.</li>
  <li>For animation rendering, improved incremental changes on the camera
    framebuffers. If a new framebuffer is specified for an incremental
    camera, the list of framebuffers is cleaned. In earlier versions
    framebuffers were accumulated, which lead to issues when rendering
    animations of echoed scenes.</li>
  <li>For finalgathering, provide a way to enforce finalgather computation of
    a per object/per instance basis. .mi syntax for objects and instances has
    been extended with <code>finalgather force &lt;bool&gt;</code>. Usual
    scene DAG inheritance rules apply. The default value is <code>off</code>. 
    <p>The <code>miIrrad_options</code> structure has been extended with
    <code>finalgather_force</code> member , so that a shader has a
    possibility to overwrite the value from the scene DAG. The default value
    is 0 (inherit). The value 1 can be used to enable, the value 2 to disable
    finalgather force computation. This option makes the <em>"state-&gt;type
    = miRAY_LM_VERTEX;"</em> trick obsolete.</p>
    <p>If finalgather force is enabled, mental ray will compute finalgather
    indirect illumination directly at the hit point instead of interpolating
    it from the finalgather map. This produces more accurate result image at
    the price of increased rendering time.</p>
  </li>
  <li>With <code>-finalgather_passes 0</code> command line option, it is now
    possible to enable the compatibility mode for finalgather map computation
    used in mental ray 3.6+ and prior (all finalgather points are placed in
    one pass, somewhat lower memory consumption especially for images with
    huge resolution).</li>
  <li>On Linux platforms, add <code>-m32/-m64</code> option to the default
    C++ compiler and linker option list (invoked for MetaSL shader
    compilation with MetaSL C++ backend enabled). In particular, this
    simplifies deployment of 32-bit mental ray executable on 64-bit Linux
    platform. On MacOSX this option has already been used in the earlier
    mental ray versions.</li>
  <li>Improved physical memory utilization by avoiding unnecessary
    large<em><strong>continuous</strong></em> memory blocks. In particular,
    scenes using finalgather maps and shaders using <code>mi_kdtree_*</code>
    interface are affected,as well as scenes with BSP2 acceleration in the
    debug build or in combination with multihosted rendering.</li>
  <li>Provide <code>-progressive_max_time F</code> command line option in
    addition to the equivalent string option. This option limits mental ray
    progressive rendering and iray execution time. </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Echo requirements for struct and array of struct shader parameters
    properly. In particular, fixed missing shader instances and textures
    passed as values for such parameters.</li>
  <li>Fixed echo of per-object min/max sample parameters.</li>
  <li>Cylinder area light sources were echoed as discs, fixed.</li>
  <li>Fixed echo of subdivision surface vertices with <code>dart</code>s.</li>
  <li>Fixed <code>-output off</code> command line option: it disabled all
    image file outputs instead of suppressing executions of output
  shaders.</li>
  <li>For 3-dimensional DDS textures, fixed error message (unsupported image
    format subtype).</li>
  <li>On Windows platforms, fixed "Permission denied" error when creating
    directory for shader cache.</li>
  <li>Fixed a crash in unlinking a shader library if MetaSL LLVM backend has
    used to create some (other) shaders.</li>
  <li>For MetaSL compiler, fixed compilation of BSDFs used as parts of
    phenomena.</li>
  <li>For MetaSL Phenomena provided as xmsl files, set all internal default
    parameter values properly even when they do not belong to the phenomena
    external interface.</li>
  <li>For MetaSL compiler, fixed code generation for shader classes inherited
    from base shader classes.</li>
  <li>For MetaSL runtime, added missing message passing (trace call returns)
    for several matrix and vector types.</li>
  <li>For MetaSL LLVM backend, fixed selection of shader primary output. In
    particular, this fixes black image rendering if MetaSL light shaders were
    used.</li>
  <li>For MetaSL C++ backend, fixed compiler crashes for
    <code>Occlusion_options</code>, <code>Irradiance_options</code>,
    <code>Light_sampler_options</code>, <code>Light_profiles,</code>
    <code>Particle_map</code>, and <code>Particle_map_options</code>
    constructors.</li>
  <li>For MetaSL C++ backend, fixed illegal code generated for some
    overloaded matrix and vector functions.</li>
  <li>For MetaSL C++ backend, fixed illegal code generated for the
    <code>Bsdf</code> type.</li>
  <li>For MetaSL C++ backend, fixed illegal code generated for
    <code>Cube</code> and <code>Spectrum</code> texture samplers.</li>
  <li>For MetaSL C++ backend, fixed swizzles for types other than float.</li>
  <li>For mental ray used as a standalone MetaSL compiler (<code>ray
    -mslc</code> command line option), fixed generation of uniform and const
    constructor attributes.</li>
  <li>For <strong>iray</strong>, fixed possible crash when rendering is
    canceled.</li>
</ul>

<h3>Changes in version 3.8.1.10</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed an unknown tag fatal or crash for MetaSL shaders with texture
    parameters having default values.</li>
  <li>For file search path substitutions (like those specified with
    -<code>T/-texture_path</code> command line option), fixed wrong handling
    of back slashes used in combination with the '<code>!</code>' sign.</li>
  <li>For hair rendering, initialize <code>miState::inv_normal</code> to
    <code>miFALSE</code> for hair hits. For hairs, the flag is meaningless.
    However, initializing it improves compatibility with non-hair-specific
    shaders respecting surface orientation.</li>
  <li>Fixed potential crashes at standalone mental ray shutdown and at
    unloading of raylib.dll. Static destructors are called after
    mi_raylib_exit(). Some of static destructors could potentially access
    memory blocks in mental ray memory management systems, which could cause
    a crash. In order to avoid this type of issues, mental ray memory system
    is changed to release <em>only</em> internal pages with no used blocks on
    them. This potentially may cause a memory leak after unloading
    raylib.dll. 
    <p>Shader writers and application developers are strongly discouraged
    from using non-trivial static destructors.</p>
  </li>
</ul>

<h3>Changes in version 3.8.1.9</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For mental ray standalone, allow multiple <code>-T</code> /
    <code>-texture_path</code> commands on the command line.</li>
  <li>On MacOSX platforms, mental ray loads shader library with
    <code>dlopen/dlsym</code> instead of the platform-specific NS* function
    family.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a performance regression in rasterizer. The regression was due to
    unnecessary frequent memory allocations / deallocations.</li>
  <li>For progressive rendering and iray used in combination with DISP
    protocol, fixed growing memory consumption during long "single-frame"
    rendering sessions.</li>
  <li>Fixed a crash if <code>mi_query</code> function was called in
    <code>miQ_PRI_BBOX_MIN/MAX</code> modes with null
    <code>state-&gt;pri</code>. <code>mi_query</code> now returns
    <code>miFALSE</code> in these cases.</li>
  <li>Fixed possible crash if the <code>link</code> statement has been
    applied on a file of an unknown or unsupported type.</li>
  <li>For MetaSL C++ backend, fixed code generation for initialization of
    inputs of struct types containing texture fields and for inputs that are
    arrays of structs.</li>
  <li>For MetaSL LLVM backend, added missing implementation of uniform and
    const constructors and destructors.</li>
  <li>For MetaSL runtime, fixed <code>orthographic</code> state variable.</li>
  <li>Fixed a memory leak in MetaSL compiler.</li>
</ul>

<h3>Changes in version 3.8.1.8</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>On MacOSX platform, added a default substitution rule <code>.so -&gt;
    .dylib.</code> Old shader libraries with <code>.so</code> extension must
    be renamed. The consistent <code>.so/.dll/.dylib</code> substitution
    rules provide <code>.mi</code> scene cross-platform compatibility.</li>
  <li>For MetaSL shader cache, add user name to the temporary directory
    created to keep the cache. This fixes possible permission conflicts if
    mental ray is used by multiple users on the same machine.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash when echoing camera with multiple framebuffers.</li>
  <li>Fixed missing echoing of ink<code>link</code> statements.</li>
  <li>Avoid echoing of shader declarations derived from MetaSL
    (<code>msl/xmsl</code>) files.</li>
  <li>For BSP2 acceleration, fixed possible infinite loop and artifacts if
    <code>mi_trace_continue</code> function or volumetric rendering with
    <strong>autovolume</strong> mode used.</li>
  <li>Implemented missing functionality of MetaSL shader distribution in
    multihosting rendering. MetaSL shaders are send to slaves in text form
    and generated by each slave host on demand with its own MetaSL compiler
    and backend.</li>
  <li>For MetaSL compiler, fix boolean control expression in the
    <code>switch</code> statement.</li>
  <li>For MetaSL compiler, fixed improper logic in some of
    <code>switch/break/continue/return</code> combinations.</li>
  <li>For MetaSL C++ backend, generate correct code for constructors of
    texture samplers used in expressions.</li>
  <li>MetaSL compiler errors were printed by a wrong module, fixed.</li>
  <li>For mental ray standalone invoked as a metasl compiler in order to
    (re)generate MetaSL code (<code>-mslc -t msl</code> command line
    options), fixed missing half/double qualifiers on the literals. </li>
  <li>Fixed possible mental ray crash at shutdown if MetaSL compiler was used
    in the session.</li>
  <li>For iray on MacOSX platform, load <code>libiray.dylib</code> (instead
    of <code>.so</code>) .</li>
  <li>On Windows platforms, errors in plugin loading (MetaSL LLVM backend,
    iray) were silently ignored. Added printing out system error
  messages.</li>
</ul>

<h3>Changes in version 3.8.1.7</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed crashes in multihosting rendering (regression in version
    3.8.1.6/3.8.1.5). Fixed sending link statements from master to
  slaves.</li>
  <li>On MacOSX platform, load <code>gen_llvm.dylib</code> (not
    <code>.so</code>) for LLVM MetaSL backend.</li>
  <li>For MetaSL C++ backend, fixed significant performance issue for array
    shader parameters.</li>
  <li>For MetaSL C++ backend, fixed texture sample constructors used in
    expressions. Fixed possible wrong type generated for temporary
  swizzles.</li>
</ul>

<h3>Changes in version 3.8.1.6</h3>

<p><strong>Known issues in this version:</strong></p>
<ul>
  <li>In multihosted rendering, a slave would crash when the second library
    is send from master to the slave host.</li>
  <li>On MacOSX platforms, mental ray searches for LLVM backend under the
    name <code>gen_llvm.so</code>, not <code>gen_llvm.dylib</code>.</li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Improved sampling of IBL (image based lighting), which results in
    better quality images and in faster convergence of IBL used in
    combination with progressive rendering.</li>
  <li>On MacOSX platforms, dynamic libraries (shaders, plugins) file
    extension is switched to <code>.dylib</code>. mental ray still allow
    shaders to have .so extension on these platforms. On Windows, a default
    substitution rule <code>.dylib -&gt; .dll</code> is added. On Linux, a
    default substitution rule <code>.dylib -&gt; .so</code> is added. On
    MacOSX, <code>.so</code> is not substituted into <code>.dylib</code> in
    order to provide compatibility with old shaders.</li>
  <li>For applications integrating raylib with progressive rendering, changes
    the <code>mi_rc_progressive_tonemapper_function</code> by adding an
    opaque pointer argument passed to the callback function registered. Note
    that this changes binary interface and the applications may require
    re-compilation as well as minor textual changes if plain C is used.</li>
  <li>For <strong>iray</strong>, provide full support for the
    <code>mia_physicalsun</code> shader.</li>
  <li>For <strong>iray</strong>, improved overall performance. In particular,
    the performance of image processing with both DISP and
    <code>mi_rc_progressive_*</code> interfaces has been improved.</li>
  <li>For <strong>iray</strong>, extended support for several OEM
  shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For mental ray standalone on windows platforms, fixed a memory
    corruption popup window if rendering is aborted (In particular, by
    pressing Ctrl-C).</li>
  <li>Fixed linking info/progress messages incorrectly printed from the DBN
    module.</li>
  <li>For MetaSL parser, fixed possible incorrect handling of
    import<code>#import</code> token.</li>
  <li>For MetaSL compiler, fixed wrong/missing const expression
  evaluations.</li>
  <li>For MetaSL LLVM backend, fixed memory leaks.</li>
  <li>For MetaSL LLVM backend, fixed crashes in half and double texture
    samplers and matrices.</li>
  <li>For MetaSL LLVM backend, fixed handling of <code>default</code> case in
    <code>switch</code> statements.</li>
  <li>For MetaSL LLVM backend, fixed support for <code>light_shadow</code>
    output of light shaders.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For <strong>base</strong> and <strong>physics</strong> shaders, added
    missing <code>apply</code> attributes.</li>
  <li>For <strong>lume</strong> shader package, removed the declaration of
    the <code>LumeTools</code> shader used to GUI attributes only.</li>
</ul>

<p></p>

<h3>Changes in version 3.8.1.4</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For progressive rendering, lift the restriction that task size had to
    be a multiple of subsampling size.</li>
  <li>For standalone MetaSL compiler option of mental ray
    (mslc<code>-mslc</code> command line option), added a possibility to
    output MetaSL files. Unused output of binary MetaSL file (.bmsl) is
    removed.</li>
  <li>For raylib integration, expose progressive rendering API in the plain C
    interface.</li>
  <li>For mental ray standalone, allow to specify the value <code>cpu</code>
    for the <code>-iray</code> command line option. With <code>-iray
    cpu</code> option, <strong>iray</strong> rendering will use CPU mode even
    if CUDA-capable GPU is present in the system.</li>
  <li><strong>iray</strong> is switched back to CUDA library version 2.2 in
    order to improve compatibility with drivers.</li>
  <li>For MetaSL LLVM backend, added support for shader parameter
    initializers.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Adjusted module id enumeration to keep same error/warning codes as for
    mental ray 3.7+ and earlier versions.</li>
  <li>For progressive rendering, changed the default value of the
    <code>"progressive error threshold"</code>string option to 0.05, as
    documented. The value for earlier versions was 0.1.</li>
  <li>For MetaSL compiler, implemented missing compatibility between Spectrum
    and Color, Spectrum and float3, Spectrum and float4 classes. </li>
  <li>For MetaSL compiler, fixed a possible crash if '<code>const
    String</code>' type was used.</li>
  <li>For MetaSL C++ backend, map MetaSL half literals (like 1.0h) to C++
    float literals properly.</li>
  <li>For MetaSL LLVM backend, added missing support for invocation as a
    shadow shader.</li>
  <li>For MetaSL LLVM backend, added missing <code>dot(int, int)</code>
    function, <code>Occlusion_options</code> constructor, and
    <code>String</code> <code>==</code> and <code>!=</code> operators.</li>
  <li>For MetaSL LLVM backend, fixed handling of destructors on leaving
    scopes with <code>break</code>, <code>continue</code> and
    <code>return</code> operators.</li>
  <li>For <strong>iray</strong>, fixed wrong light transforms.</li>
  <li>For <strong>iray</strong>, fixed superfluous verbosity.</li>
</ul>

<p></p>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For precompiled MetaSL shader library, added a set of missing intrinsic
    shaders.</li>
  <li>The <code>paint.mi</code> file no longer links <code>base.so</code>
    explicitly. Though paint phenomena depend on base shaders, the way to
    link shader explicitly was inconsistent with <code>rayrc</code>
    configuration workflow.</li>
</ul>

<h3>Changes in version 3.8.1.3</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For mental ray standalone used as a MetaSL compiler (<code>-mslc</code>
    command line option), allow file arguments to be specified after compiler
    options.</li>
  <li>For <strong>iray</strong>, added support for directional light
  sources.</li>
  <li>The GUI attributes for several shader declaration files are moved into
    separate files. These GUI files are only used by some of the OEM raylib
    integrations and are excluded from other release tapes.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For raylib integrations, fixed possible unknown tag fatal or crash when
    framebuffers are deleted.</li>
  <li>For Map containers, added removal of temporary swap files in case of
    rendering abort.</li>
  <li>For MetaSL LLVM backend, fixed several issues related to the inlining
    in the generated code with high optimization level (controlled by the
    <code>MI_METASL_LLVM_OPTLEVEL</code> environment variable).</li>
  <li>The version <strong>3.8.1.2</strong> 64-bit Linux platform specific
    issue with MetaSL LLVM backend has been fixed.</li>
  <li>For MetaSL LLVM backend, fixed tangent space code, swizzle constructors
    for atomic types, and parameters to the sample iterators.</li>
  <li>For MetaSL C++ backend, fixed literal string symbol escaping.</li>
  <li>For raylib OEM integration, fixed a corruption in the GUI attributes
    handling.</li>
</ul>

<h3>Changes in version 3.8.1.2</h3>

<p>Known platform-specific issue in this version: On 64-bit Linux, the MetaSL
LLVM backend asserts for most of MetaSL shaders.</p>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>On Linux and MacOSX systems, changed the way the external compiler and
    linker are invoked. The standard /bin/sh shell is used to redirect
    external tool output (stdout and stderr) into temporary files. The
    <code>fork</code>-based solution used in previous versions was not
    reliable due to the extensive usage of phtread library (multiple threads,
    locks). 
    <p>The environment variable <code>MI_DEBUG_INVOKE</code> is no longer
    used.</p>
  </li>
  <li>For MetaSL LLVM backend, environment variable
    <code>MI_METASL_LLVM_OPTLEVEL</code> could be used to control the
    optimization. It is recommended to set it to 1 on Windows platforms in
    order to increase generate code reliability.</li>
  <li>For <strong>iray</strong>, added support for the <code>"progressive
    error threshold" F</code> string option, which stops rendering when
    specified quality is reached.</li>
  <li>For <strong>iray</strong>, improved support for light shaders.
    Currently point, rectangle disc and cylinder light area types are
    supported. <code>physical_light</code> and
    <code>mib_light_photometric</code> (including light profiles) light
    shaders are supported.</li>
  <li>For <strong>iray</strong>, significantly reduced the amount of noise
    for scenes with IBL (image based lighting).</li>
  <li>For <strong>iray</strong>, improved support of several OEM material
    shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a possible crash in multihosted rendering for scenes using
    instance light lists.</li>
  <li>Fixed on-demand texture filtering (added in version 3.8.0.11) for
    textures of tiny resolution.</li>
  <li>For the BSP2 acceleration, fixed possible improper handling of
    visibility flags of assemblies. Regression in mental ray 3.8.</li>
  <li>For <strong>iray</strong>, fixed possible rendering artifacts with more
    than 4 threads.</li>
  <li>For <strong>iray</strong>, fixed an issue in sampling generation
    causing significant visual difference between images rendered on GPU and
    on CPU.</li>
  <li>For LLVM backend, fixed texture sampler constructors and texture
    width/height.</li>
</ul>

<h3>Changes in version 3.8.1.1</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Extended DISP talk protocol. The frame begin reply string has not the
    form 
    <p><code>frame_begin: &lt;frameno&gt; &lt;xres&gt; &lt;yres&gt;,
    &lt;is_output_shader&gt;</code></p>
    <p>where is_output_shader is 1 for output shaders and 0 for normal
    rendering. This allows display applications to distinguish the rendering
    and postprocessing stages.</p>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the <code>imf_disp</code> tool, fixes creating of the second frame
    if output shaders are used in the scene.</li>
</ul>
<ul>
  <li>For MetaSL LLVM backend, fixed type conversion for mental ray scene
    parameters.</li>
</ul>

<h3>Changes in version 3.8.1.0</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added <code>-assert_fatal &lt;bool&gt;</code> command line option. If
    set to <code>off</code>, mental ray would continue execution after
    assertion (and possibly crash later). Default is <code>on</code>. This
    option should be used for debugging purposes only. It may be also used to
    prevent popup on Windows platforms in batch processing.</li>
  <li>For MetaSL shaders, added native support for <code>half</code>
  type.</li>
  <li>For MetaSL shaders, improve mapping of MetaSL types to mental ray
    types. In particular, added support for matrix types.</li>
  <li>Changed signature of the recently added
    <code>mi_lookup_*_texture_x</code> functions, the filter is passed by
    value.</li>
  <li>For the <code>.mi</code> parser, remove the limit of 4096 characters
    per line.</li>
  <li>For the <code>iray</code>, improved light source handling.</li>
  <li>Removed left-overs of the deprecated hardware rendering (mental ray
    3.4) from the shader and integration interface.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed echo of the <code>premultiplied</code> framebuffer flag.</li>
  <li>Allow BSDFs to be nested inside of Phenomena.</li>
  <li>Fixed a crash for MetaSL shaders used in combination with multi-hosted
    rendering.</li>
  <li>For the standalone MetaSL compiler functionality, only shaders having
    <code>brdf_type</code> annotation are compiled as BRDFs even with
    <code>--brdf</code> command line option is specified.</li>
  <li>For MetaSL C++ backend, fixed possible wrong initializers inside of
    phenomena.</li>
  <li>For MetaSL shaders, fixed possible artifacts due to wrong volume in/out
    stack computation.</li>
  <li>For MetaSL shaders, fixed missing support for camera
    <code>dof_focus</code>.</li>
</ul>

<h3>Changes in version 3.8.0.12</h3>

<p>mental ray's ability to flatten shading trees and Phenomena specified with
.mi syntax or mental ray API and consisting of nodes which are MetaSL shaders
has been disabled for 3.8 release. The value of the registry
<code>{_MI_REG_METASL_FLATTEN}</code> is ignored. This does not affect
flattening of Phenomena provided as XMSL files.</p>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added support for the combination of stereoscopic rendering in
    combination with progressive rendering.</li>
  <li>For the rasterizer, changed the default value of the
    <code>premultiplied</code> framebuffer flag added in version
    <code>3.8.0.8</code> to <code>true</code>. The new default behavior is
    backward-compatible with mental ray 3.7 and rendering with rasterizer
    disabled.</li>
  <li>Improved performance for progressive rendering and iray used with DISP
    callbacks and protocols.</li>
  <li>For the MetaSL LLVM backend, added support for the explicit shader
    calls from MetaSL shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For <strong>iray</strong>, fixed possible crash for scenes using
    textures.</li>
</ul>

<h3>Changes in version 3.8.0.11</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li><strong>iray</strong> functionality has been encapsulated into a
    plugin. This removes the symbol dependencies on the CUDA runtime from OEM
    raylib libraries. The plugin is name is <code>"iraylib.dll/.so"</code>.
    mental ray searches for this library on the path list for the shader
    lookup (same mechanism as for the gen_llvm MetaSL backend). The plugin is
    loaded automatically. 
    <p>Standalone and SPM-protected mental ray libraries are now delivered
    with iray plugin and CUDA runtime libraries. The plugin installation is
    required only for rendering in the iray mode ( <code>-iray</code> command
    line option).</p>
  </li>
  <li>On 64-bit MacOSX platform, provide CPU fallback functionality for
    <strong>iray</strong>.</li>
  <li>Provide MIPMAP pyramids for effective filtered texture lookup on
    demand. Like in the earlier version, mental ray will create MIPMAP
    pyramids for textures declared filtered at the load/memory map/cache
    insertion time. If a texture is <strong>not</strong> declared filtered,
    the pyramids are created on demand when
    <code>mi_lookup_color_texture(_x)</code> or
    <code>mi_lookup_filter_color_texture(_x)</code> function are called for
    these textures and the upper pyramid levels would improve the
    performance. Same applies for MetaSL shader filtered texture lookups. 
    <p>The original image data is not changed, so on-demand MIPMAP pyramids
    are not available for shaders using low-level <code>mi_img_*</code>
    interface.</p>
  </li>
  <li>For MetaSL compiler and C++ backend, added support for user data.</li>
  <li>For MetaSL LLVM backend, added support for a plurality of features,
    including mental ray - MetaSL parameter conversions and compilation of
    light shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a regression: shader cache did not update changed metasl
  code.</li>
  <li>Fixed a regression: in network rendering, the link statements for
    compiled C/C++ (.so/.dll files) shaders (.so/.dll files) were not
    propagated from the master host to the slaves.</li>
  <li>For MetaSL integration, fixed possible wrong default parameter values
    in the XMSL phenomena emulation mode (registry
    <code>{_MI_REG_METASL_EMULATE_MI_PHEN}</code> set on).</li>
  <li>Fixed possible false error message on camera stereo mode.</li>
  <li>The function <code>void mi_msg_usleep(int secs);</code> is restored in
    the integration interface.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Improved architectural shader applied to the glass and similar
    materials. If after several bounces inside of a glass the trace depth
    limit has been reached, the black or environment color has been returned.
    In bright environments this lead to visible "light leak" artifacts. The
    shader behavior is changed to trace a transparent ray instead of picking
    environment or black color. It is a better approximation to the true
    result of several additional reflection/refraction light bounces. For
    compatibility reasons, the old behavior still could be achieved by
    setting the per-shader trace depth limit to the value "-1".</li>
</ul>

<h3>Changes in version 3.8.0.10</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the BSP2 acceleration and the special case of the shutter interval
    <code>[0,0]</code> with motion blur option <strong>enabled</strong>, use
    <strong>static</strong> acceleration structure in order to improve
    performance and reduce memory consumption.</li>
  <li>For the MetaSL C++ backend, added support for displacement shaders.</li>
  <li>On Windows platforms, removed run-time overhead related to the
    discontinued MetaSL CIL backend. mental ray kernel no longer relies on
    the .Net installation.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>On Windows platforms, fixed a crash when MetaSL compiler LLVM backend
    was initialized. The functionality of LLVM is still limited, only simple
    shaders can be compiled in this version.</li>
  <li>Fixed possible deadlock or assertion in the debug mental ray version.
    The issue has been observed if a MetaSL shader has been deleted, or if
    the IBL feature was used.</li>
  <li>Expose <code>mi_rc_run_query</code> function to the shader interface.
    Though this function is intended for the integration, some existing
    mental ray shaders depend on it.</li>
  <li>For IBL rendering, fixed switching IBL modes between frames.</li>
  <li>Fixed a crash in multihosted rendering if finalgather was used.</li>
  <li>For MetaSL shaders, fixed possible crash in filtered texture
  lookup.</li>
  <li>For MetaSL shaders compiled with C++ backend, fixed possible improper
    handling of vector parameters.</li>
</ul>

<h3>Changes in version 3.8.0.9</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For iray integrated for into OEM libraries, the fallback into the CPU
    solution has been implemented for Windows and 32-bit MacOSX in addition
    to Linux.</li>
  <li>For MetaSL shaders and C++ backend, added support for volume
  shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash if an attempt to compile MetaSL shader with non-existing
    compiler backend was done.</li>
  <li>Fixed possible crash if mental ray 3.5 compatibility framebuffer syntax
    was used (regression in version 3.8.0.8).</li>
  <li>For <code>imf_disp</code> tool, removed possible display
  flickering.</li>
</ul>

<h3>Changes in version 3.8.0.8</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>MetaSL LLVM backend. A new backend for MetaSL shaders is provided. This
    backend replaces CIL backend on Windows platforms (superior performance
    and uniformity of the solution on all platforms). The backend is
    supported on Windows, Linux and MacOSX: 32 and 64 bit each. 
    <p><strong>The support for MetaSL CIL backend on Windows is
    discontinued.</strong></p>
    <p>As the name implies, the backend is based on the LLVM technology.
    There is no dependency on external compilers or linkers. The compilation
    is done on demand in memory, no intermediate files are created.
    Currently, it is not possible to externalize shaders compiled with the
    LLVM backend. Thus, such shaders are not stored into the compiled shader
    cache. However, in case a shader has been compiled with C++ backend
    (using external C++ compiler), the existing shaders in the compiled
    shader cache would be used. Shaders compiled with LLVM and with C/C++
    compiler can be mixed in one scene, phenomenon or shading tree.</p>
    <p>In order to enable MetaSL LLVM backend, it is necessary to:</p>
    <ul>
      <li>Set the registry <code>" {_MI_REG_METASL_BACKEND}"</code> value to
        <code>"LLVM"</code> or <code>"llvm"</code>.</li>
      <li>Make sure that the file gen_llvm.so / .dll is present in the path
        list where mental ray searches for shaders. This paths are specified
        by the <code>-L</code> command line option and by the
        <code>"{_MI_REG_LIBRARY}"</code> registry value.</li>
    </ul>
    <p>LLVM MetaSL backend library is loaded automatically when the first
    MetaSL shader is compiled.</p>
    <p>This version of LLVM backend is an initial implementation, only
    simplest shaders will compile successfully Known issue: on windows
    platforms, gen_llvm will crash at initialization.</p>
  </li>
  <li>OEM integration libraries now contain a functional version of
    <strong>iray</strong> on 32 and 64 bit Windows and Linux, as well as on
    32-bit MacOSX. The 64-bit version of MacOSX is planned. 
    <p>In this release, iray is linked statically into the mental ray
    library. T</p>
    <p>On Linux system, an automatic detection of the presence of
    CUDA-capable graphics card is provided. If not available, CPU mode is
    enabled. This functionality is planned for Windows and MacOSX as well.</p>
    <p>In this version, iray relies on CUDA compute capability version
    1.1.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added new function 
    <pre>    miBoolean mi_trace_probe_x(
        miState        state,
        const miVector *direction,
        const miVector *origin,
        miUint         flag );</pre>
    This function is similar to <code>mi_trace_probe</code>, but takes a
    bitmask of visibility flags to test hits for. The enumeration for the
    flags is added to the <code>shader.h</code> interface file.</li>
  <li>For the rasterizer, allow per-framebuffer control over the compositing.
    The new per-framebuffer modifier <code>"premultiplied"</code> on/off has
    been added to the <code>.mi</code> syntax. If set, the compositing of a
    color framebuffer(primary or user) is done according to the formula
    <code>(A + (1-opacity) * B)</code>, otherwise it is <code>(opacity * A +
    (1-opacity) * B)</code>.</li>
  <li>For MetaSL shaders, added support for <code>ddx/ddy</code>. The
    expressions only apply for normals, points and texture coordinates. Note
    that the normal derivatives are computed for the interpolated normal
    without the effect of bump shaders.</li>
  <li>For the <code>imf_disp</code> tool, added "always on top"
  functionality.</li>
  <li>For the <code>imf_dis</code>p tool, added mouse wheel scrolling of the
    window.</li>
  <li>For the <code>imf_disp</code> tool, and DISP talk protocol, added the
    ability to specify region of interest in the progressive rendering
  mode.</li>
  <li>For the <code>imf_disp</code> tool, display currently rendered
    rectangle.</li>
  <li>For the <code>imf_disp</code> tool used for stereoscopic images, allow
    to select one of the possible ways to display stereo images
    (<code>View</code> menu item): 
    <ul>
      <li>Color Anaglyph (default)</li>
      <li>Grey Anaglyph</li>
      <li>Half Color Anaglyph</li>
      <li>Left Only</li>
      <li>Right Only</li>
    </ul>
  </li>
  <li>For Irradiance Particles, allow to specify number of secondary rays
    with additional parameters to the <code>-ip_rays</code> command line
    option. Before it was only possible with a .mi file string option.</li>
  <li>Missing <code>const</code> qualifiers are added to the public API.</li>
  <li>Improved runtime performance for MetaSL shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible wrong illumination if IBL was used in a combination with
    other light sources.</li>
  <li>Fixed possible artifacts in motion blur scenes rendered with BSP2
    acceleration.</li>
  <li>Fixed missing visible lights in scenes with no geometry.</li>
  <li>For applications integrating raylib, fixed a possible deadlock if a GUI
    element with the same name is re-defined without deleting the old
  one.</li>
  <li>Fixed possible crash in rendering of multiple frames with incremental
    camera changes which switch stereoscopic rendering on/off.</li>
  <li>Put some memory blocks allocated with global
    <code>new</code>/<code>new[]</code> operators under mental ray memory
    management/statistics system.</li>
  <li>For integrated version of mental ray, fix the table of exported symbols
    needed for the integration.</li>
  <li>For the <code>imf_disp</code> tool, link EXPAT library statically. The
    dynamic library is missing on some older Linux system.</li>
  <li>For the <code>imf_disp</code> tool, fixed several image displaying
    issues.</li>
  <li>For MetaSL shaders, fixed a series of bugs related to type conversions
    and multiple output.</li>
  <li>For MetaSL shaders, fixed inefficiently in the coordinate system
    transformations.</li>
</ul>

<h3>Changes in version 3.8.0.7</h3>

<p><strong>Known limitations in this version:</strong></p>
<ul>
  <li>Type system and parts of the MetaSL compiler SDK and runtime system
    (including headers) have been refactored. Work in progress. In
    particular, CIL backend currently fails to compile many shaders. </li>
  <li>Performance of MetaSL shaders using array parameters is very poor.</li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added a support for number of area light samples, which is not an exact
    power of 2. Prior to this version, mental ray would increase the number
    of sample for area lights. In the current implementation, the exact
    number of samples to be taken is respected up to the u * v = 64. In order
    to keep old behavior, the number of samples per light in the scene could
    be adjusted to be an exact power of 2.</li>
  <li>Added echo for the <code>.msl</code> / <code>.xmsl</code> file include
    statements.</li>
  <li>Missing <code>const</code> qualifiers are added to the public API.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For IBL, fixed possible shadow artifacts. The shadow rays are shot from
    the lights towards telemetry, like this is done for usual lights. This
    increases compatibility of IBL with existing shadow shaders.</li>
  <li>On 64-bit Linux machines, fixed possible memory corruption crash. The
    crash has been in particular been observed during rendering of large
    scenes with <code>scanline on</code>.</li>
  <li>Fixed possible crash in raylib integration. If an application was low
    on memory and a new thread has been registered with raylib, the
    application memory handle callback could be called in order to inform
    application that some memory should be freed if possible. At the moment
    of the call, the thread is not registered into raylib yet and thus no
    calls to mental ray functions should be done. In order to prevent
    possible crash, added a check to <code>mi_info</code>,
    <code>mi_warning</code>, <code>mi_error</code> etc.: if called from
    threads not attached to mental ray, these functions will return
    immediately without printing any messages.</li>
  <li>For the SPM-protected mental ray executables and libraries, fixed
    possible failure to obtain the necessary number of licenses in
    core-restricted environments (such as virtual machines) and some machines
    with Intel i7 CPUs.</li>
  <li>On Windows platforms, one of the modules has been compiled with
    platform STL headers, which caused symbol conflicts for an integrated
    version of mental ray library. Fixed. The complete mental ray now is
    compiled with STLPORT put into the namespace <code>MISTD</code>. In
    particular, it does not have a dependency on the <code>_SECURE_SCL</code>
    define value.</li>
  <li>Fixed possible creases during parallel compilation of several MetaSL
    shaders.</li>
</ul>

<p></p>

<h3>Changes in version 3.8.0.6</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the integrations of raylib progressive rendering: the
    <code>mi_rc_progressive_set_buffer()</code> function get an additional
    <code>bool</code> argument with the default value <code>false</code>. If
    the new paramerer is set to <code>true</code>, multiple calls to
    <code>mi_rc_run()</code> could be used with the same framebuffer,allowing
    a simplified and more efficient call sequence as in the pseudo-code
    below. The call to <code>mi_rc_progressive_shutdown()</code> is not
    required in this case. 
    <p></p>
    <pre>    mi_rc_run(miRENDER_PREPROC|miRENDER_RENDER| ..., ... );
    mi_rc_progressive_set_buffer( ... settings ... , true);
    while (loop condition) {
        mi_rc_progressive_cancel_rendering() or mi_rc_progressive_stop_rendering();
        // do application incremental updates 
        // BSP is *not* rebuild by the kernel
        mi_rc_run(miRENDER_REINHERIT | 
                  [miRENDER_REINHERIT_LIGHTS |]
                  miRENDER_RENDER, ...);
    }
    mi_rc_run(miRENDER_POSTPROC, ...);</pre>
    <p></p>
    <p>As the binary interface of the
    <code>mi_rc_progressive_set_buffer()</code> function has been changed,
    applications with progressive rendering integration need to be recompiled
    against the new header files. No source code changes are required for
    application using the old call sequence.</p>
  </li>
  <li>Reduced memory occupied by BSP2 acceleration for motion blur
  scenes.</li>
  <li>The files generated for the debugging purposes if the registry
    "<code>{_MI_REG_METASL_TRACE}</code>" is set are put into the temporary
    files directory instead of current directory.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible crash in raylib integration. If an application was low
    on memory and a new thread has been registered with raylib, the
    application memory handle callback could be called in order to inform
    application that some memory should be freed if possible. At the moment
    of the call, the thread is not registered into raylib yet and thus no
    calls to mental ray functions should be done. In order to prevent
    possible crash, added a check to <code>mi_info</code>,
    <code>mi_warning</code>, <code>mi_error</code> etc.: if called from
    threads not attached to mental ray, these functions will return
    immediately without printing any messages.</li>
  <li>If a shader declaration was deleted, the DLL library containing the
    code for the corresponding shader implementation has been unlinked. Limit
    unlinking of the DLLs to the case of MetaSL shaders compiled by mental
    ray.</li>
  <li>Put some memory blocks allocated with global
    <code>new</code>/<code>new[]</code> operators under mental ray memory
    management/statistics system.</li>
  <li>Fixed possible crash in erroneous scenes with undefined material
    inherited as a component of material array in a scene DAG.</li>
</ul>

<h3>Changes in version 3.8.0.4</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the rasterizer, fixed possible artifacts for unsplitted quads
    crossing the clipping plane. The fix is complimentary to the fix in
    version 3.8.0.3.</li>
</ul>

<h3>Changes in version 3.8.0.3</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li><strong>Experimental.</strong> Added an experimental extension to the
    DISP talk protocol and imf_disp tool. 
    <p>The command <code>refine_fb</code> <em>xl,yl,xh,yh</em> can be used to
    specify that in the progressive rendering mode, additional samples are
    placed in the specified window if progressive rendering is used. imf_disp
    tool allows the selection of the window with the mouse.</p>
  </li>
  <li>Added <code>unlink "filename"</code> command to the .mi syntax in order
    to allow shader library replacements in mental ray standalone. Without
    this syntax, this functionality was available for raylib integration
  only.</li>
  <li>For scenes with motion blur, improved BSP2 construction time for
    objects having single motion segment.</li>
  <li>For MetaSL C++ backend, improves support for constructors and
    destructors.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For integrations of raylib containing iray, fixed possible symbol
    conflicts.</li>
  <li>For integration of raylib in a form of static library, fixed possible
    missing debug information due to several pairs of code object files with
    the same names. Relevant for Windows platforms only.</li>
  <li>For the progressive rendering displayed with the imf_disp tool, fixed
    stopping of the rendering. During the progressive rendering, the "stop"
    (red square) button of the playback button group can be used to signal
    mental ray to stop the rendering.</li>
  <li>For <code>ccmesh</code> objects, fixed memory allocations bypassing
    mental ray memory manager. This memory was not counted in statistics and
    could lead to a crash for large scenes.</li>
  <li>Fixed possible ray hit misses for BSP2 acceleration used for photons
    (globillum and caustics).</li>
  <li>Fixed a regression: registry substitution has not been applied when the
    type of linked library files has been determined, causing disfunction of
    <code>.mi</code> statements like <code>link "base.{EXT}"</code>.</li>
  <li>For the rasterizer, fixed possible artifacts for quads crossing
    clipping plane.</li>
</ul>

<h3>Changes in version 3.8.0.2</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For MetaSL shaders, implemented IOR in/out stack functionality.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Restored stop command and stop button functionality in imf_disp 2.0 for
    the progressive rendering mode.</li>
  <li>Fixed missing indirect illumination of finalgathering was used in
    combination with importons for scenes containing materials using
  BSDFs.</li>
  <li>Fixed a crash if finalgathering was used in combination with importons,
    and the importon map was empty.</li>
  <li>For MetaSL shaders used with C++ backend, fixed passing parameters over
    the <code>trace</code> calls.</li>
  <li>For MetaSL shaders used with C++ backend, generate correct code for the
    conversion of shader type parameters to boolean.</li>
</ul>

<h3>Changes in version 3.8.0.1 (incomplete list).</h3>

<p>Extended list and more detailed description for new features and changes
will be provided with the next version.</p>

<p><strong>Iray:</strong></p>

<p>Some mental ray 3.8 distributions are coming with iray. Iray is a
CUDA-based high performance path tracing renderer implementing mental images
architectural material and material library shading model. The integration of
<strong>iray</strong> into mental ray follows the raylib progressive
rendering interface. In order to enable iray, the command line <code>-iray
on</code> options, or a string option "iray" on should be used. iray is work
in progress and is not functional in this alpha version.</p>

<p><strong>New features:</strong></p>
<ul>
  <li><strong>Stereoscopic rendering.</strong> mental ray 3.8 provides a
    workflow to render two images (for the left and for the right eyes)
    simultaneously. Two rendered images are stored in two separate
    framebuffers sets and saved as pair(s) of image files. The names of the
    files are prefixed with <code>lft_</code> and <code>rgt_</code> for the
    left and right eye respectively. Stereoscopic rendering is supported for
    the <strong>rasterizer</strong> as well as <strong>scanline
    on/off</strong>. View-dependent tessellation and displacement is applied
    according to the camera located in the middle of two eye positions. Same
    applies for the computation of finalgather maps. This allows consistent
    rendering of two images and improves performance by exploiting locality
    of the data and avoiding redundant work. 
    <p>The .mi syntax for the camera is extended with </p>
    <p><code>camera "mycamera"</code></p>
    <p><code>stereo &lt;method&gt; &lt;eye_separation&gt;</code></p>
    <p><code>...</code></p>
    <p><code>end camera</code></p>
    <p>where <strong>method</strong> of left/right eye camera could be one of
    the following:</p>
    <ul>
      <li><code>off</code> Default, no stereoscopic rendering.</li>
      <li><code>toein</code> The camera frustums are rotated so that the two
        camera direction vectors meet at the focal length. This method
        introduces perceptually incorrect vertical parallax which increases
        out from the center of the projection plane and might cause a visual
        discomfort when looking at rendered stereo images for a longer
      time.</li>
      <li><code>offaxis</code> This method is the perceptually correct way to
        create stereo camera pairs. It introduces no vertical parallax and is
        therefore less stressful to the observer. It requires an asymmetric
        camera frustum, which most manufactured cameras do not support as of
        today.</li>
      <li><code>offset</code> This is the straightforward method for
        rendering stereo pairs. It shifts the eyes along the horizontal axis
        in camera space. </li>
    </ul>
    <strong>eye_separation</strong> is the distance between two eyes in
    camera space. 
    <p>It is possible to specify stereoscopic rendering parameters wit the
    command line option</p>
    <p><code>-stereo &lt;method&gt; &lt;eye_separation&gt; </code></p>
    The integration/shader API has been extended with
    <code>miCamera::miCamera_stereo</code> (enumeration) and
    <code>miCamera::eye_separation</code> members. 
    <p>Stereoscopic rendering is not supported for orthographic cameras. For
    shaders, the camera space used if the position/orientation of the camera
    in the middle of two eye.</p>
    <p></p>
  </li>
  <li><strong>New</strong> <code>imf_disp</code> <code>2.0</code>
    <strong>image viewer</strong> has been written. Unlike version 1, the
    implementation is identical on Windows, Linux and MacosX platform,
    delivering the same set of controls. 
    <p>The major improvements include the ability to display live any of the
    rendering framebuffers (not just the primary color one), zoom, display
    individual channels, expose and gamma control. Automatic tonemapping is
    provided.</p>
    <p>The new image viewer tool is compatible with <strong>progressive
    rendering</strong> and with <strong>stereoscopic</strong> images. </p>
    <p>The compete list of command line options is given below:</p>
    <pre>imf_disp [/l <str>] [/c <str>] [/e <str>] [/g <str>] [/t] [/s] 
            [--frame <num>] [--frame-rate <num>] [--live-update <str>] 
            [--cache-all-layers <str>] [--view-controls <str>] [--playback-controls <str>] 
            [--on-image-load <str>] [--disable-gl] [/h] [image files...]
 </pre>
    <pre>   -l, --layer=<layername>              layer to display
   -c, --channel=<c/r/g/b/a>            channel to display
   -e, --exposure=<exp>           set exposure
   -g, --gamma=<gamma>              set gamma
   -t, --tone-map            enable tone mapping
   -s, --stereo-display      enable stereo display
   --frame=<frame_number>                  frame to display
   --frame-rate=<fps>             set frame rate (FPS)
   --live-update             monitor file for changes
   --cache-all-layers=<on/off>       retrieve and cache all layers
   --view-controls=<on/off>          toggle displaying the view toolbar
   --playback-controls=<on/off>      toggle displaying playback toolbar
   --on-image-load=<gui_behavior>          set GUI behavior on image load
   --disable-gl              disable GL-based display</pre>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li><strong>BSP2 ray tracing acceleration</strong> is made the default one. 
    <p>For scenes <strong>without motion blur</strong>, significant to
    performance improvement and dramatically lower memory consumption have
    been achieved.</p>
    <p>For scenes <strong>with motion blur</strong>, moderate improvements on
    performance and memory consumption have been achieved. Further
    improvements are planned before mental ray 3.8 final version.</p>
  </li>
  <li><strong>Hair rendering</strong> improvements. 
    <p>For hair rendering used with <strong>ray tracing</strong>, a new
    splitting scheme is used. The scheme resolves possible rendering
    artifacts known from earlier mental ray versions and moderately improves
    the performance.</p>
    <p>No longer required <code>MI_HAIR_SPLITTING</code> environment variable
    is removed.</p>
    <p>Rendering performance of scenes with many hair objects has been
    improved.</p>
    <p>For hair rendering used in combination with the
    <strong>rasterizer</strong>, the new string option <code>"rast hair
    disposable" &lt;bool&gt; </code>has been added. Default is off. If
    enabled, mental ray will tessellate only hair parts inside of the current
    rendered tile view frustum and throw them one one the tile is rendered.
    This mode is recommended for scenes with many hair as the memory
    consumption is decreased significantly at a price of slightly longer
    rendering time.</p>
  </li>
  <li><strong>Progressive rendering</strong>, in particular the progressive
    rendering API, has been improved. For convenience, the summary of the
    options and API is given below. The complete list of options of relevant
    string options is given below: 
    <ul>
      <li><code>"progressive" &lt;bool&gt;</code> Turn progressive rendering
        on or off. The default is <code>off</code>.</li>
      <li><code>"progressive subsampling size" &lt;int&gt;</code> Enables and
        controls coarse sampling of the initial displayed images. The default
        is 0 for disabled. Values greater than 1 activate subsampling in
        blocks of pixels. The value specifies the size of pixel blocks (size
        x size) where initial samples are placed first, typically displaying
        as a coarse image with the impression of a lower resolution. The
        rendered tile size is adjusted to be a multiple of this subsampling
        size.</li>
      <li><code>"progressive min samples" &lt;int&gt;</code> Set the minimum
        number of samples per pixel to compute before considering any of the
        listed criteria to stop progressive rendering. The default is 4.</li>
      <li><code>"progressive max samples" &lt;int&gt;</code> Set number of
        samples per pixel to stop progressive rendering. The default is
      100.</li>
      <li><code>"progressive max time" &lt;int&gt;</code> Set time, in
        seconds, when to stop progressive rendering. The default is to run
        unlimited. Rendering is not guaranteed to stop exactly at the time
        specified. Especially for the low limits, certain minimal time
        exceeded those limits may be required.</li>
      <li><code>"progressive error threshold" &lt;float&gt;</code> Set error
        threshold to stop progressive rendering. The default is 0.05. A value
        of 0.0 would apply no quality-driven rendering termination. A value
        of 0.5 will stop rendering already at a very low quality.</li>
      <li><code>"progressive interactive" &lt;bool&gt;</code> For the
        integrated version of raylib, enables a high performance image
        feedback. Rendering can be displayed and modified interactively via
        the <code>mi_rc_progressive_*</code> set of integration functions.
        The DISP image mechanism and disp protocols are disabled for the
        performance reasons. Default is <code>off</code>.</li>
    </ul>
    <p>For mental ray library, the following integration API is provided:</p>
    <ul>
      <li><strong>Set the display buffer and start rendering. </strong> 
        <p></p>
        <pre>extern "C" bool mi_rc_progressive_set_buffer(
    void *display_buffer,
    const size_tstride,
    const miRc_prog_buffer_typetype,
    const boolflip);
 </pre>
        This function need to be called by the application after calling
        <code>mi_rc_run()</code>. It provides the buffer used by the
        application for display to the core and implicitly starts rendering. 
        <p>Two types of buffers are supported, 8 bit and floating point. </p>
        <pre>typedef enum {
    PROG_BUFFER_RGBA_8 = 0,// RGBA, 8bit
    PROG_BUFFER_RGBA_32= 1,// RGBA, 32bit fp
} miRc_prog_buffer_type;</pre>
        <p><strong>Remark:</strong> different pixel layouts (like BGRA) could
        be implemented by providing a tonemapper function that swaps
        channels.</p>
      </li>
      <li><strong>Update the display.</strong> The application can ask mental
        ray core at any time if more samples have been computed to be
        displayed. The recommended workflow is to query the number of
        computed frames via <code>mi_rc_progressive_get_update_count()</code>
        call with certain time intervals to see if there is something new to
        display. If a new frame is computed,
        <code>mi_rc_progressive_update_buffer()</code> can be used to copy
        its data to the application's display buffer. The special method
        <code>mi_progressive_update_buffer_first_subframe()</code> will
        always return the first subsampled frame, which allows to display
        constant image while moving the camera (which can be less visually
        disturbing to the user). 
        <pre>extern "C" miUint mi_rc_progressive_get_update_count();
extern "C" miUint mi_rc_progressive_update_buffer();
extern "C" miUint mi_rc_progressive_update_buffer_first_subframe();
 </pre>
        There are special return values to the calls to above: 
        <pre>enum {
    // The rendering is not running (not yet started or already 
    // been shut down)
    MI_RC_PROGRESSIVE_NOT_RUNNING = 0xfffffff,
    // The rendering has finished rendering and is on hold until the
    // application calls mi_rc_progressive_shutdown()
    MI_RC_PROGRESSIVE_FINISHED = 0xfffffff - 1
};
 </pre>
        If the rendering is finished (maximum number of samples taken), the
        rendering can either be reset using
        <code>mi_rc_progressive_set_camera()</code> or it can be shutdown
        using <code>mi_rc_progressive_shutdown()</code>. </li>
      <li><strong>Camera interaction.</strong> User-driven navigation can be
        implemented by calling <code>mi_rc_progressive_set_camera()</code>
        function. This call stops the current rendering, sets the camera to
        the specified values and restarts rendering from there. It is a full
        reset of the rendering and the frame number returned by
        <code>mi_rc_progressive_get_update_count()</code>,
        <code>mi_rc_progressive_update_buffer()</code> and
        <code>mi_rc_progressive_update_buffer_first_subframe()</code> are
        reset to 0. 
        <p></p>
        <pre>extern "C" void mi_rc_progressive_set_camera(
    const miMatrix camera_instance,
    const miCamera*camera);
 </pre>
      </li>
      <li><strong>Stop or cancel a running rendering.</strong> The rendering
        can be stopped or canceled at any time. Stopping mental ray kernel
        will complete the current frame. This can be used to allow user
        interaction based termination of rendering. Canceling the rendering
        will stop sampling immediately, not finishing the current frame, and,
        thus, allows to end rendering as fast as possible. 
        <p></p>
        <pre>extern "C" void mi_rc_progressive_stop_rendering();
extern "C" void mi_rc_progressive_cancel_rendering();</pre>
      </li>
      <li><strong>Shutting down the interactive mode.</strong> If the
        rendering has finished (e.g. of the error threshold has been
        fulfilled, the maximum samples were done, or the rendering was
        canceled), the mental ray kernel waits for a shutdown to complete.
        After shutting down the interactive mode, none of the API functions
        are allowed to be called. Interactive rendering can be restarted by
        calling <code>mi_rc_run()</code> and
        <code>mi_rc_progressive_set_buffer()</code>. 
        <p></p>
        <pre>extern "C" void mi_rc_progressive_shutdown();</pre>
      </li>
      <li><strong>Tonemapping.</strong> At any time during rendering it is
        possible to enable or change tonemapping which can be used for
        applying gamma correction or adjusting the brightness on the fly.
        Tonemapping is implemented by registering a function which mental ray
        kernel will call per pixel. The tonemapping used for interactive
        display purpose only. The framebuffer contains the values without
        tonemapping. When the final image is written to disk, the desired
        tonemapping can be implemented by using an output shaders. 
        <p>Tonemapping functions need to map an arbitrary floating point
        value to the valid interval [0,1], i.e. clamping to the maximum
        displayable value of 1 and minimum value of 0 has to be performed.
        The default builtin tonemapper implements [0,1] clamping with no
        further pixel modifications. </p>
        <p>Although the tonemapping function can be changed at any time, the
        tonemap function can be called called until the current frame has
        been transferred to the application. Tonemapping is executed in
        parallel (multithreaded). The tonemapping function should be
        thread-safe. </p>
        <pre>extern "C" void mi_rc_progressive_set_tonemapper_function(
    void(*tonemapper)(float out[3], const float in[3]));</pre>
      </li>
    </ul>
  </li>
  <li><strong>Image based lighting (IBL)</strong> performance has been
    improved. IBL compatibility with MetaSL shaders has been improved.</li>
  <li><strong>Finalgather combination</strong> with Irradiance particles and
    with Importons have been enabled. If finalgather is used in combination
    with Irradiance Particles, the second and higher diffuse bounces are
    computed with help of irradiance particles. If finalgather is used in
    combination with importons, importon distribution is used to drive the
    distribution of finalgather rays. Especially for scenes with HDR (high
    dynamic range) lighting, this may result in a faster convergency/better
    images with the same computational efforts.</li>
  <li>DISP protocol has been extended in order to support stereoscopic
  images.</li>
  <li><strong>MetaSL 1.1 support. </strong> mental ray 3.8 will provide
    extended support for MetaSL shaders with the updated language
    specification. The stability, performance and functionality coverage are
    significantly improved. 
    <p>MetaSL integration is subject to active development in this alpha
    version. In particular, the planned LLVM-based backend is not a part of
    this release.</p>
  </li>
  <li><strong>Shader cache</strong>. mental ray provides a mechanism to avoid
    recompilation of MetaSL shaders with CIL/.Net (Windows) and C++ backend.
    Same mechanism applies to the C++ shaders provided as source. 
    <p>If enabled (default), mental ray will create an MD5 hash code and
    create a .so / .dll library identified by that hash code, the platform
    (32 or 64 bit, Windows, Macosx or linux etc), debug or optimized, and
    mental ray version. This gives a unique identification of a shader and
    avoids possible conflicts if different version or mental ray are
    installed on the same system (such as 32 and 64-bit executables).</p>
    <p>The following registries control the shading cache behavior:</p>
    <ul>
      <li><code>{_MI_SHADER_CACHE_ENABLE}</code> if not set to "off" /
        "false", the cache is enabled.</li>
      <li><code>{_MI_SHADER_CACHE_DIR}</code> if set, specified the directory
        to use for the shader cache.</li>
      <li><code>{_MI_SHADER_CACHE_SIZE}</code> if set, specifies the size of
        the cache to maintain, in Megabytes.</li>
    </ul>
    <p>For network rendering, mental ray distributes the source code of
    metasl shaders. Each host participating in the network rendering compiles
    shaders individually. This includes heterogeneous network support and
    possible combination of different backends, like CIL on windows machines
    and C++ on Linux machines.</p>
  </li>
  <li>mental ray 3.8 adds the ability to <strong>remove MetaSL
    shaders</strong> from the scene database, and to <strong>change</strong>
    and <strong>r<strong>e-define them</strong></strong>. This allows the
    workflow when the MetaSL shader source code is edited interactively. In
    mental ray 3.7+ it was necessary to assign a new name for such shaders. 
    <p>In the current version, shader instances referring to MetaSL shader
    need to be deleted before MetaSL shader modification. It is planned to
    remove this requirement for the case when only the implementation part of
    the shader, but not the interface input/output parameters are changed.</p>
  </li>
</ul>

<p></p>

<p><strong>Changes affecting compatibility with mental ray
3.7/3.7+.</strong></p>

<p>Overview of the Information related to the changes between mental ray
3.7/3.7+ and 3.8 can be found in the <strong>upgrading38.html</strong>
section of the manual.</p>
<ul>
  <li>In order to specify MetaSL backend to be used, the
    <code>"{_MI_REG_METASL_BACKEND}"</code> registry should be set to
    <code>"c++",</code><code>"cil"</code> or <code>"llvm"</code>. The
    <code>"{_MI_REG_METASL_CIL}"</code> registry used in mental ray 3.7+ to
    enable CIL backend is ignored.</li>
  <li>For MetaSL CIL backend, mental ray 3.8 puts most of the managed glue
    code into the <code>metasl_runtime.dll</code> assembly to be shared
    across all compiled shaders. This assembly file should be located in the
    same directory as the application and/or mental ray standalone
    executable. Alternatively, it should be registered in GAC ("global
    assembly cache") with <code>gacutil -i metasl_runtime.dll</code> command
    once at mental ray installation. 
    <p>Note that default Windows security policy does not allow assemblies to
    be loaded from network drives. This may impose some constrains on the
    application / mental ray installation process.</p>
  </li>
  <li>MetaSL shaders compiled for mental ray 3.7+ cannot be used with mental
    ray 3.8.</li>
  <li>On Linux and Macosx platforms, the shaders are compiled with
    <code>-fvisibility=hidden</code> flag. This is done in order to avoid
    symbol conflicts. Shader writers should make sure to specify the
    visibility attribute or use <code>DLLEXPORT</code> define for the
    exported symbols.</li>
  <li>For versions of mental ray linked with iray, it is necessary to have
    the CUDA runtime library (<code>cudart.dll/libcudart.so</code>) to be
    installed on the system in order to start mental ray.</li>
</ul>

<h3>Changes in version 3.7.55.26.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a fatal if virtual or cached framebuffers were used, and the
    temporary directory is not writable. mental ray will print a warning and
    fall into in-memory framebuffers instead.</li>
  <li>Fixed improper handling of color profiles applied to user
  framebuffers.</li>
  <li>In finalgather map lookup, added a tests for shaders incorrectly
    flipping normal without setting <code>miState::inv_normal</code>
    properly. Fixes possible black indirect illumination rendering for some
    double-sided materials.</li>
</ul>

<h3>Changes in version 3.7.55.25.</h3>

<p><strong>Feature improvements</strong>:</p>
<ul>
  <li>To allow application-driven configuration of the external compiler
    tools used to compile MetaSL shaders with C++ backend, added the
    following registries: 
    <ul>
      <li><code>{_MI_REG_CPP_COMPILER}</code> if set, specifies the C++
        compiler</li>
      <li><code>{_MI_REG_CPP_COMPILER_FLAGS}</code> if set, specifies the C++
        compiler flags</li>
      <li><code>{_MI_REG_LINKER}</code> if set, specifies the path to the
        linker</li>
      <li><code>{_MI_REG_LINKER_FLAGS}</code> if set, specifies liker
      flags</li>
      <li><code>{_MI_REG_MANIFEST_TOOL}</code> if set, specifies the manifest
        tool to use on Windows platforms. </li>
    </ul>
  </li>
  mental ray standalone command line option take precedence over the registry
  values.</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible crash in <code>ccmesh</code> object tessellation.</li>
</ul>

<h3>Changes in version 3.7.55.24.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>On Linux/MacOS platforms, do not spawn threads for external
    compiler/linker invocation if the registry
    <code>{_MI_REG_DEBUG_INVOKE}</code> is set. The change is complimentary
    to the environment variable added in 3.7.55.21.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL shaders compiled with C++ backend, fixed possible crash if
    an array parameter in .msl file had an initializer.</li>
  <li>For MetaSL compiler, issue a meaningful error message is a
    non-implemented function <code>get_ray_data</code> or
    <code>clear_ray_data</code> is used. 
    <p></p>
  </li>
</ul>

<h3>Changes in version 3.7.55.21.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Improved error reporting for mental ray standalone invoked with -mslc
    version for MetaSL compilation.</li>
  <li>On Linux/MacOS platforms, do not spawn threads for external
    compiler/linker invocation if the environment variable
    <code>MI_DEBUG_INVOKE</code> is set. This may be useful for debugging as
    <code>gdb</code> is has issues on debugging applications using pthread
    fork/join.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL CIL backend, fixed possible crash for shaders using array
    input parameters.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For architectural material shader, fixed possible artifacts if the
    "thin wall" feature is been used in combination with finalgather.</li>
  <li>For architectural material shader, fixed possible black noise artifacts
    in the alpha channel when trace depth is exceeded.</li>
</ul>

<h3>Changes in version 3.7.55.19.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For mental ray standalone, changed the command line option
    <code>-progress_frequency</code> <em>&lt;num&gt;</em> to accept float
    number for the percentage progressive message frequency. Previous
    versions required an integer.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For raylib integration, fixed possible crash in attaching application
    thread to raylib (call to <code>mi_msg_register_thread()</code> function)
    while mental ray is low on memory.</li>
  <li>Fixed a crash if progressive rendering is used in combination with
    contours: disabled contour rendering. These two features are
    algorithmically incompatible.</li>
  <li>For MetaSL CIL backend, fixed non-functional
    <code>Light_iterator_options::set_shadows</code> and
    <code>Light_iterator_options::set_cone</code> methods.</li>
  <li>For MetaSL CIL backend, fixed possible invalid code generated for light
    samplers. Fixed possible memory corruption related to light samplers.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the architectural material round corner shader, use both (front and
    back) faces of the object to detect object corners instead of the face
    specified by global options, object or instance. For one-faces objects,
    some corners were not detected. </li>
  <li>For the production <code>mip_binaryproxy</code> shader, fixed a crash
    if an invisible object (no trace/visible flags) has been created. Fixed
    missing database tag unpinnig which could have negative effect on mental
    ray database flushing when mental ray is low on memory.</li>
</ul>

<p></p>

<h3>Changes in version 3.7.55.16.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For finalgather precomputation, the face flag for the eye ray has been
    mistakenly initialized from the options block in a way, so that kernel
    considered it as set by shader and gave it higher priority than the
    object / instance flags, which thus have been ignored.</li>
  <li>For MetaSL shaders, fixed
    <code>Light_iterator::set_shadows(false)</code> option. The option is
    only active if the light shader is a MetaSL one.</li>
  <li>For MetaSL CIL backend, fixed compilation of coping of Trace_options,
    Occlusion_options, and Irradiance_options.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Fixed a crash in the architectural portal light shader if the light
    instance for the shader call has not been set.</li>
</ul>

<h3>Changes in version 3.7.55.14.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Support triangle vertex access for displacement shaders called on
    subdivision surfaces. When called from a displacement shader applied to a
    <code>ccmesh</code> subdivision surface, the <code>mi_tri_vectors</code>
    function returns the position, normal, texture, motion and derivative
    vertex data for an incident triangle to the current displaced vertex. For
    position, the last refinement level is used instead of the limit position
    which is overwritten during displacement mapping.</li>
</ul>

<h3>Changes in version 3.7.55.13.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the <strong>DEBUG</strong> version of mental ray on Linux and
    Macosx, do not use <code>phtread_join/fork</code> for the external
    compiler and linker invocations. This allows debugging with
    db<code>gdb</code>. <code>gdb</code> has a known issue (freeze) while
    dealing with these system function calls. <strong>Note:</strong> a
    disadvantage on this change is that debug mental ray will not capture the
    output of invoked processes.</li>
  <li>For mental ray standalone invoked as MetaSL compiler with -mslc option,
    the process will return non-zero on a compilation failure.</li>
  <li>For C++ code generated with mental ray MetaSL compiler, set the MI_RAY
    define. This removes the requirement to add the define on the C++ command
    line for shaders compiled manually.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL compiler, fixed an issue of not passing member variables to
    the <code>main()</code> methods of shaders generated from phenomena. Also
    fixed possible loosing of array specifiers for such variables.</li>
  <li>For MetaSL compiler, fixed possible crash on compiling illegal MetaSL
    source code, such as <code>get_trace_depth()</code> without
  parameters.</li>
  <li>For MetaSL CIL backend, fixed possible illegal managed code due to a
    too low stack limit.</li>
  <li>For MetaSL shaders, fixes possible crash on loading shaders using
    parameters of <code>Shader</code> type.</li>
</ul>

<p></p>

<h3>Changes in version 3.7.55.12.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For possible crash or database fatal for scenes which do not fit into
    memory completely. A reference to subobject could stay in the kernel
    after the complete object with subobjects was flushed for the second
  time.</li>
  <li>For MetaSL compiler, added missing support for deprecated functions
    like <code>trace_immediate</code>.</li>
  <li>For MetaSL compiler, assure that shaders using <code>call</code>
    function will not beak C++ compilation, even though the calls will not be
    functional.</li>
  <li>For MetaSL shaders, fixed texture wrong coordinate space used for
    texture tangents.</li>
</ul>

<h3>Changes in version 3.7.55.10.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL shaders, fixed wrong ray origin setup used for occlusion
    rays.</li>
  <li>For MetaSL XSML phenomena emulated in mental ray (precompiled MetaSL
    shaders mode), fixed possible wrong translation for phenomena which are
    not trees (example: an output of shader A is used as input for shaders B
    and C, and an output of shader B is used in shader C). The symptoms of
    the issue: API error messages on unknown shaders and broken shading due
    to the partial phenomena created.</li>
  <li>For MetaSL XSML phenomena emulated in mental ray (precompiled MetaSL
    shaders mode), allow phenomena with color + transparency roots.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For architectural material shader, fixed a performance regression in
    case of multibounce finalgathering used in combination with "fake glossy
    reflection" feature of the shader.</li>
</ul>

<h3>Changes in version 3.7.55.8.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For progressive rendering, added color profiles support for interactive
    image output. Optimized pipeline for color profile image tile conversion.
    In the case of progressive rendering, apply fast but slightly less
    accurate conversion routines. Speedup general image conversion routine by
    avoiding unnecessary function calls and memory allocations.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixes possible hangs and z-clipping artifacts in rendering of scenes
    with motion blur with rasterizer. The precision of the z-clipping
    computation is increased.</li>
  <li>For BSP2 acceleration used with <code>shutter_delay = shutter &gt;
    0,</code> fixed possible shadow artifacts due to the static BSP2 tree
    used in this case. Note that with this fix, the memory allocated by the
    BSP2 acceleration is increased, but stays below the memory required for
    motion BSP2 acceleration.</li>
  <li>For MetaSL compiler, fixed a regression in version 3.7.55.4. For
    precompiled shaders, state variable modifications were ignored in some
    cases. In particular, bump mapping was missing in some of phenomenon.</li>
  <li>For MetaSL compiler, fixed mental ray crash if an <em>illegal</em> code
    with input/output parameters of builtin types like
    <code>Irradiance_options</code>, which are not intended for passing
    between shaders. An error message is added.</li>
  <li>For MetaSL compiler, fixed default constructor expression <code>Type
    t();</code> and <code>Type t = Type();</code> for "non-fundamental"
    builtin types <code>Irradiance_options</code>,
    <code>Light_iterator_options, Sample_iterator</code> etc.</li>
  <li>For MetaSL compiler, fixed possible crash in the compiler for shaders
    with multiple s of type parameters of type <code>Texture*</code>.</li>
  <li>For MetaSL CIL backend, set FLOAT/DOUBLE/HALF_MIN/MAX defines to the
    platform specific values.</li>
</ul>

<h3>Changes in version 3.7.55.7.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL C++ backend, set FLOAT/DOUBLE/HALF_MIN/MAX defines to the
    platform specific values.</li>
  <li>For MetaSL shaders with int2/int3/int4 and bool2/bool3/bool4 input
    parameters, fixed wrong initialization from .mi vector/color types.</li>
  <li>For MetaSL compiler, fixed broken xmls phenomena connecting inputs to
    outputs directly.</li>
  <li>Fixed possible MetaSL compiler crash if an (illegal) MetaSL shader in
    the graph misses main method.</li>
</ul>

<h3>Changes in version 3.7.55.6.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multiple bounce finalgathering, fixed wrong depth count for
    secondary finalgather rays. Refraction limit has been applied instead of
    reflections.</li>
  <li>For multiple bounce finalgathering, fixed wrong <em>default</em>
    importance setting applied to the 3rd and higher diffuse bounces. This
    resulted in a higher number of rays used, shifting the scene rendering
    towards higher quality on the same settings.</li>
  <li>For MetaSL C++ backend, fixed possible illegal code generated for the
    <code>sincos</code> function calls.</li>
</ul>

<h3>Changes in version 3.7.55.5.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For progressive rendering used with SPM-protected mental ray
    executables, fixed defect threshold-error-driven adaptivity.</li>
</ul>

<h3>Changes in version 3.7.55.4.</h3>

<p>mental ray manual has been updated for this version.</p>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>The new library, <code>intrinsics.dll</code> /
    <code>intrinsics.so</code>, has been added. The library contains the set
    of 400+ MetaSL intrinsic shades. Linking this library may significantly
    reduce memory consumption and improve performance if MetaSL shaders are
    used.</li>
  <li>For progressive rendering, adjusted the set of exposed string options
    and command line commands: 
    <p><code>-progressive &lt;bool&gt; </code></p>
    <p><code>-progressive_subsampling_size &lt;int&gt;</code></p>
    <p><code>-progressive_min_samples &lt;int&gt; </code></p>
    <p><code>-progressive_max_samples &lt;int&gt; </code></p>
    <p><code>-progressive_error_threshold &lt;float&gt;</code> </p>
    <p>Corresponding string options are <code>"progressive"</code>,
    <code>"progressive subsampling size"</code>, <code>"progressive min
    samples"</code>, <code>"progressive max samples"</code> and
    <code>"progressive error threshold"</code>.</p>
    <p>The <code>-progressive_subsampling</code> command line option has been
    renamed to match the string option name.</p>
    <p>The new options set allows usage of progressive rendering with
    adaptive sampling. The <code>"progressive min samples"</code> specifies
    the minimal number of samples used. "progressive max samples" and
    "progressive error threshold" specify the maximal number of samples and
    estimated error level to be used per pixel before stop, whatever criteria
    is reached first.</p>
  </li>
  <li>On Linux and Macosx, when an external compiler or linker is invoked,
    its output to <code>stdout</code> is captured by mental ray kernel and
    printed out as LINK module debug messages. The output to
    <code>stderr</code> is printed as LINK module error messages. For Windows
    platforms, same functionality has been added earlier in version
  3.7.52.14.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Path substitution rules have not been applied to the file names of
    framebuffers. One of the effects of this bug was that the small stub file
    for <code>imf_disp</code> interactive display has been created at the
    correct location, but the framebuffer file has been saved somewhere else
    or failed to save. Fixed.</li>
  <li>On Windows, fixed initialization of the noise table with changing
    values for several mental ray invocations.</li>
  <li>On 32-bit MacOSX platform, for SPM-protected executable, fixed possible
    crash in the beginning of the second frame rendering.</li>
  <li>Fixed echo of the scenes with IBL.</li>
  <li>For multihosted rendering, fixed possible crash at the end of the frame
    for scenes using assemblies. Some scenes with BSP2 acceleration may be
    affected as well.</li>
  <li>Fixed potential rare crash if mental ray was low on memory and flushed
    parts of the scene.</li>
  <li>For integrated version of mental ray, fixed possible rendered tile
    tag/memory leak in case of aborting rendering.</li>
  <li>For MetaSL shaders, for<em>occlusion</em>rays, fixed initialization of
    returned hit data like distance to the hit point. </li>
  <li>For MetaSL shaders, fixed possible unknown tag fatal if an undeclared
    texture was used as a MetaSL shader parameter (usually passed as default
    value).</li>
  <li>For MetaSL C++ backend, fixed incorrect code generated for user-defined
    functions having the names conflicting with standard C++ ones.</li>
  <li>For MetaSL CIL backend, fixed incorrect code generated for the
    <code>for</code> loops containing declarations in initializers and for
    assignments elements of arrays of structures.</li>
  <li>For MetaSL compiler, respect platform-specific values for the value
    interval defines like FLOAT_MIN/MAX, INT_MIN/MAX etc.</li>
  <li>For MetaSL compiler, fixed possible crash at loading of phenomena
    containing BSDFs.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For architectural material shader, bump vector with zero first 2
    component but not-zero 3rd component has not been applied, fixed.</li>
</ul>

<p></p>

<h3>Changes in version 3.7.55.3.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a major memory leak regression in case of 8bit rendered images in
    combination with virtual framebuffers (<code>-fb_virtual on</code>) and
    interactive display (<code>imf_disp</code>) attached.</li>
  <li>For ray-traced hair with motion blur, fixed possible rendering
    artifacts due to too small bounding boxes used.</li>
  <li>For MetaSL shaders, added missing support for the
    <code>light_type</code> member of the light state.</li>
  <li>For MetaSL compiler, fixed generation of the code for matrix
    <code>operator*=</code> operators.</li>
  <li>For MetaSL compiler, fixed compilation of <code>Type t();</code> and
    <code>Type t=Type();</code> constructor expressions.</li>
  <li>For MetaSL C++ backend, fixed possible illegal code generated for right
    hand side swizzles.</li>
  <li>For MetaSL CIL backend fixed compilation of shaders with
    <code>int2</code>, <code>int3</code>, <code>bool2</code> and
    <code>bool3</code> parameters.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Fixed missing output passes in the <code>"mi_car_paint_phen_x"</code>
    phenomenon.</li>
</ul>

<h3>Changes in version 3.7.55.2</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For hair rendering, fixed possible artifacts due to the hair radius not
    taken into account when bounding boxes were computed.</li>
  <li>Fixed rendering artifacts for objects with number of motion segments
    higher than the global motion steps options.</li>
  <li>For ambient occlusion, fixed possible artifacts and assertion in the
    debug version if a negative number of AO rays was requested or if a
    negative importance factor has been used.</li>
  <li>For multihosted rendering used in heterogenous network, fixed possible
    crashes when rendering scenes with finalgathering. The crash was due to
    binary incompatibility of the network protocol for 32 and 64-bit
  machines.</li>
  <li>For multihosted rendering, fixed possible rare crash due to
    inappropriate pincounting.</li>
  <li>Fixed possible crash at shutdown if cached framebuffers (command line
    <code>-fb_virtual cache</code>) were used.</li>
  <li>For mental ray used with cached framebuffers (command line
    <code>-fb_virtual cache</code>) fixed possible short delays when multiple
    tiles appears in display window in bunches. The tiles displaying is made
    more uniformly in time.</li>
  <li>Fixed a regression in MetaSL compiler causing a crash during the
    internal generation of shader declaration.</li>
  <li>For MetaSL compiler, fixed the order of handling for include files and
    user types declared in such files.</li>
  <li>For MetaSL shaders, fixed compilation of a shaders returning structs
    containing substructs.</li>
  <li>For MetaSL CIL backend, fixed compilation of some matrix constructors
    and 4-vectors constructed from a couple of 2-vectors.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For base and subsurface scattering lightmap shaders, significantly
    reduced memory consumption for scenes with large triangles covering high
    number of pixels in the lightmap mesh rendering.</li>
</ul>

<h3>Changes in version 3.7.55.1</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the scene echo, if the value of an <code>miBoolean</code> is
    neither <code>miTRUE</code> nor <code>miFALSE</code>, echo it as an
    integer.</li>
</ul>

<h3>Changes in version 3.7.55.0</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Improved reaction time on rendering aborts, especially those during
    finalgather precomputation stage displayed interactively. mental ray
    kernel copies rendered tiles to the framebuffer asynchronously. The
    outstanding tiles are no longer copied after abort signal.</li>
  <li>For progressive rendering, intercept invalid subsample size values
    below 1.</li>
  <li>For MetaSL shaders, added support for light loops
    <code>light_<code>dot_nl</code></code>, <code>light_uv</code>,
    <code>light_area</code> and <code>light_area_delta</code> state
  variables.</li>
  <li>For MetaSL shaders, initialize <code>light_distance_limit</code> with
    huge scalar.</li>
  <li>For MetaSL shaders, renamed some runtime header files.</li>
  <li>For MetaSL shader runtime, improve robustness of the tangent space
    computation.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For scenes with assemblies, fixed possible freeze and memory leak on
    assembly deletion at the end of the frame rendering.</li>
  <li>For MetaSL shader integration, fixed possible memory corruption for
    shaders and phenomena using textures and other parameters identified by
    name.</li>
  <li>For MetaSL C++ backend, properly initialize array fields of structs in
    the structs default constructor. This fixes a runtime crash if such
    constructors were used.</li>
  <li>For MetaSL C++ backend, fixed illegal code generation: generate
    user-defined types before functions defined in #include files.</li>
</ul>

<p></p>

<h3>Changes in version 3.7.52.15</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed conversion of scalar half-float textures.</li>
  <li>Added missing support for half-floats for pass files.</li>
</ul>

<h3>Changes in version 3.7.52.14</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>On Windows platforms, avoid popup windows for integrated version of
    mental ray library when external commands for shader compilation are
    invoked. Affected are MetaSL shaders with CIL and C++ backend, as well as
    shaders provided in form of C/C++ source code, as .obj object file and as
    .lib static libraries. 
    <p>When such external compiler, linker, CIL assembler or manifest
    embedding is invoked, its output to <code>stdout</code> is captured by
    mental ray kernel and printed out as LINK module debug messages. The
    output to <code>stderr</code> is printed as LINK module error messages.
    Some of the external tools put error-style messages into
    <code>stdout</code>, so for troubleshooting it is recommended to run
    mental ray with debug output (<code>-v 6</code> command line option for
    mental ray standalone).</p>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash if a very long (8 kilobytes) error/warning/info/debug
    message has been created. On Windows platforms, a protection mechanism
    for such messages issued from shaders existed prior this version.</li>
  <li>When parsing a .mi file, allow includes of .msl / xmsl files between
    top-level grammar elements only. This ensures that elements with no
    grammatic "end" marker, like textures, are completed before the included
    file is processed. 
    <p>Fixes the issue on texture declarations described in the release note
    for version 3.7.52.13.</p>
  </li>
  <li>For MetaSL shaders, fixed several issues in initialization of arrays.
    This fixes possible crash at runtime when array elements were used.</li>
  <li>For MetaSL compiler, make sure that string initializers for textures
    and light profiles are not accepted for local variables.</li>
  <li>For MetaSL compiler, fixed <code>lerp</code> function compilation.</li>
  <li>For MetaSL compiler, removed left-over code dumping ambiguous
  overloads.</li>
  <li>For MetaSL CIL backend, fixed code generation for constructors of
    structs.</li>
  <li>For MetaSL CIL backend, fixed code generation for functions with array
    parameters.</li>
  <li>For MetaSL CIL backend, fixed several minor memory leaks.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For MetaSL noise generation shaders, replaced currently not supported
    swizzles in the parameter initializers with equivalent code without
    swizzles.</li>
</ul>

<h3>Changes in version 3.7.52.13</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Standalone version of mental ray can be used as a MetaSL compiler
    directly. Command line options following the new <code>-mslc</code>
    option are passed to the compiler. The compiler is invoked instead of
    mental ray renderer if the option is present. For example, the
    combination <code>-mslc -h</code> will print out compiler options. 
    <p>Current version of the compiler can be used to produce C++ (<code>-t
    cpp</code>) and .mi declaration (<code>-t mi</code>) files, hardware
    shader compilation is not included.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>In mental ray options/camera info banner printed before rendering, use
    semantics / name of the framebuffer instead of the framebuffer index.</li>
  <li>Improved performance of the DISP module in case <code>imf_disp</code>
    is attached to an image rendered with 16bit, float or half pixels. The
    improvement is primarily relevant for progressive rendering. This
    improvement does not apply to cached (tiled) framebuffers, which are not
    recommended for usage with progressive rendering for general performance
    reasons.</li>
  <li>For MetaSL C++ backend, implemented support for texture resources
    specified as default MetaSL shader input parameter values. 
    <p>Note that such textures need to be declared before including XMSL
    files, like</p>
    <p><code>filter 1.0 color texture "default.dds"
    "MyDefaultTexture.jpg"</code></p>
    <p>Due to the way mental ray parser works in the current version, it is
    also required to explicitly terminate texture grammar before the
    including msl/xmls files. This can be done with a "<code>set</code>"
    statement like:</p>
    <p><code>set "MetaSL default textures provided" "on"</code></p>
    <p>The latter limitation will be removed in the future versions
    (<strong>fixed in 3.7.52.14</strong>).</p>
  </li>
  <li>Output messages from MetaSL compiler are now given according to
    compiler submodules, not "LIB" as in the previous versions.</li>
  <li>For MetaSL C++ backend, generate framebuffer access code only when
    required. This removes frequent C++ compiler warning on unused
    <code>fb_index</code> variable.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For mental ray 3.5 framebuffer compatibility interface, fixed wrong
    handling of user framebuffers 6 and 7.</li>
  <li>For the second "talk" version of the DISP interactive display protocol,
    fixed wrong image pixel depth. For the primary color buffer, the actual
    pixel type used in the framebuffer is announced and sent through the
    protocol. 
    <p>If the primary framebuffer is known under multiple names, all names
    are listed with the <code>fb_list_name</code> command.</p>
    <p>Fixed possible wrong indices for some framebuffers.</p>
  </li>
  <li>For progressive rendering, fixed possible crash if rendering in a low
    image resolution.</li>
  <li>For progressive rendering, fixed a crash if output shaders were
  used.</li>
  <li>For standalone mental ray, fixed a crash if more than one
    <code>-texture_path</code> options was used on the command line.</li>
  <li>For recently added internal support for <code>half</code> type, added
    missing clipping in <code>mi_img_clip_color</code> function.</li>
  <li>For MetaSL compiler, fixed a crash if both input parameter initializer
    and annotations were present.</li>
  <li>For MetaSL compiler, added missing constructors for Trace_options.</li>
  <li>For MetaSL compiler, fixed possible crash in nested switch
  operator.</li>
  <li>For MetaSL compiler and backends, added missing <code>is_nan</code> and
    <code>is_finite</code> functions.</li>
  <li>For MetaSL compiler, fixed conversions between <code>float3</code>,
    <code>float4</code>, <code>Color</code> and <code>Spectrum</code>
  types.</li>
  <li>For MetaSL C++ backend, fixed possible broken generation of the code
    for texture space access.</li>
  <li>For MetaSL CIL backend, fixed compilation failures for shaders using
    ray types and light types.</li>
  <li>For MetaSL CIL backend, fixed compilation of shaders using
    <code>clamp</code> function.</li>
  <li>For MetaSL CIL backend, fixed compilation of shaders using
    <code>any</code> and <code>all</code> functions.</li>
  <li>For MetaSL CIL backend, fixed compilation of shaders using
    <code>abs</code> function on integers and integer vectors.</li>
  <li>For MetaSL CIL backend, fixed string comparison operators.</li>
  <li>For MetaSL CIL backend, added support for member constructors and
    destructors.</li>
  <li>For MetaSL CIL backend, fixed a regression for shaders using ray
  types.</li>
  <li>For MetaSL shaders runtime, avoid asserts in creating local orthonormal
    basis </li>
  <li>For MetaSL shaders runtime, request to unsupported value of type
    <code>float2</code> returned uninitialized value, added initialization
    with zeroes.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Fixed MetaSL shader source code for shaders using reserved
  keywords.</li>
</ul>

<p><strong>Known MetaSL limitations in this version:</strong></p>
<ul>
  <li>The following parts of MetaSL 1.0 specification are not supported by
    mental ray 3.7+, and not planned to: 
    <ul>
      <li>Material Phenomena</li>
      <li>Techniques</li>
      <li>3D and Cube textures</li>
      <li>MetaSL Spectrum is mapped onto mental ray color type</li>
      <li>Particle maps are not supported</li>
      <li>Some limitations on array and struct input/outputs apply. In
        particular, output array parameters are not supported.</li>
      <li>Native functions</li>
      <li>Explicit shader invocation</li>
      <li>Derivatives and ray differentials</li>
    </ul>
  </li>
  <li>mental ray shader parameter type is a subset of MetaSL type system. A
    parameter type conversion mechanisms is applied which may result in
    precision loss. </li>
  <li>Textures for default texture parameters need to be declared explicitly
    before MetaSL shaders.</li>
  <li>MetaSL CIL backend has worse performance compared to C++ backend. C++
    backend is the recommended solution.</li>
  <li>The following issues are known in this versions but planned to be fixed
    in the mental ray 3.7+ final release: 
    <ul>
      <li>For input parameters of MetaSL shaders, initializers using swizzles
        are not supported.</li>
      <li>Texture blur is not supported.</li>
      <li>Some of the light state members are not supported.</li>
      <li>CIL backend is less complete than C++ backend. For CIL backend,
        default input texture parameters are ignored. Some of initializers
        are not working properly.</li>
      <li>Switch between (precompiled) C++ shader backend and CIL backend is
        global, not per shader.</li>
    </ul>
  </li>
</ul>

<h3>Changes in version 3.7.52.12</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Implemented detection if a shader parameter has been assigned a value.
    This mechanism is required in order to allow MetaSL shader input
    parameter constructors which are not constant values. The order of
    default values is: 
    <ul>
      <li>.mi file or mental ray API value of a shader
        <strong>function</strong>.</li>
      <li>Default value of the input parameter in the MetaSL code.</li>
      <li>Default value of the input parameter in .mi file or mental ray API
        shader <strong>declaration</strong>.</li>
      <li>Zero value / black.</li>
    </ul>
    <p>In order to accommodate this changes, the i_is_connected
    <code>mi_is_connected</code> macro has been added. The
    <code>miFunction::has_connection</code> field has been added, which is
    set if at least one shader parameter is connected.</p>
    <p><strong>Note that this change may affect shader binary
    compatibility:</strong></p>
    <p>Old shaders using <code>mi_eval</code> and <code>mi_call</code> macro
    for parameter evaluation will work with the new kernel without changes
    and recompilation. For the performance reasons it is recommended to
    recompile these shaders with the new <code>shader.h</code> header
    file.</p>
    <p>Shaders which accessed internal ghost tags directly in order to check
    for the connected parameters may require minor source code modification.
    The <code>mi_is_connected</code> macro should be used instead of direct
    access.</p>
  </li>
  <li>Implemented support for "half" (16-bit floats). Prior versions of
    mental ray supported 16-bit-float OpenEXR textures, but the internal
    representation used 32-bits. Native 16 bit representations saves almost
    50% of memory occupied by textures. 
    <p><strong>Note that old .map textures of rgb_h/rgba_h image types are
    binary incompatible with the new version of mental ray.</strong> If used,
    such textures will be loaded into memory and converted, but they will not
    be memory-mapped.</p>
  </li>
  <li>For MetaSL C++ backend, implemented support for non-constant input
    parameter initializers in MetaSL shaders.</li>
  <li>Reduced memory consumption of the MetaSL CIL backend code generator and
    improved its performance.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>If compatibility framebuffer interface was used, user framebuffers 6
    and 7 have not been written out correctly, fixed.</li>
  <li>For MetaSL compiler, add a warning for older MetaSL phenomena assigning
    values to output parameters in XMSL files. These values are ignored.</li>
  <li>For MetaSL compiler, changes the names of texture samplers according to
    the MetaSL specification.</li>
  <li>For MetaSL compiler, added missing implicit type conversion handling
    for the conditional <code>"? :"</code> expressions.</li>
  <li>For MetaSL compiler, fixed a regression in compilation of
    <code>abs</code>, <code>acos</code> and some other builtin functions.</li>
  <li>For MetaSL compiler, fixed comparisons operators for textures and
    sampler.</li>
  <li>For MetaSL compiler, avoid assigning values directly to the xmsl
    phenomena output parameters.</li>
  <li>For MetaSL compiler, fixed <code>operator %=</code>.</li>
  <li>For MetaSL compiler, fixed <code>vector *= matrix</code> and
    <code>matrix *= vector</code> operators.</li>
  <li>For MetaSL compiler C++ backend, fixed possible crash when arrays of
    length zero were used.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the <code>mip_render_subset</code>, fixed possible artifacts if
    rendering of placeholder objects in combination with coverage framebuffer
    filtering was used.</li>
  <li>For the production <code>mip_motionblur shader</code>, fixed possible
    black stripe artifacts.</li>
  <li>For the paint shaders, the <code>mi_metallic_paint_output_mixer</code>
    was not linked into the library, fixed.</li>
  <li>For the architectural material shader, fixed possible NaN artifacts
    originating from dot normal precision.</li>
</ul>

<h3>Changes in version 3.7.52.10</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Extended the second "talk" version of the DISP interactive display
    protocol with the "fb_list_name" command. It lists currently active
    framebuffers, one line per buffer: 
    <p><code>fb_list_name: <em>&lt;framebuffer
    index&gt;</em>,</code><code><em>&lt;int image type&gt;</em> <em>&lt;image
    type name with +-prefix, like +rgba&gt;</em>, <em>&lt;int
    resolution_x&gt;</em> <em>&lt;int resolution_y&gt;</em>, <em>&lt;int
    number of image components&gt;</em> <em>&lt;bits per pixel
    component&gt;</em>, "<em>&lt;framebuffer_name&gt;</em>"</code></p>
    <p>The framebuffer name is quoted. Also fixed a bug in
    <code>fb_list</code> command which did not list all the framebuffers.the
    second version, </p>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For progressive rendering, fixed a possible crash in displaying
    miscounted DISP tiles.</li>
  <li>For MetaSL shaders compiled with flattened enabled, fixed missing
    compilation of light shaders.</li>
  <li>For MetaSL compiler, added missing implicit type conversion handling
    for the conditional <code>"? :"</code> expressions.</li>
  <li>For MetaSL C++ backend, avoid a compiler crash if no main method is
    present in a shader source.</li>
  <li>For MetaSL C++ backend, added missing support for shader static member
    constructors.</li>
  <li>For MetaSL CIL backend, fixed wrong code generation for
    <code>switch</code> used with non-consecutive enum <code>case</code>
    labels.</li>
  <li>For MetaSL CIL backend, fixed generation of the code for construction
    of matrices from matricide of some other dimensions.</li>
  <li>For MetaSL CIL backend, fixed generation of the code with changed
    capitalization of texture sampler methods, follows recent MetaSL
    specification adjustment.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the <code>mip_metallic_paint(_x)</code> shader, fixed wrong
    illumination if multiple area light sources are present in the scene.</li>
  <li>For the production <code>mip_rayswitch_stage</code> shader, fixed
    declaration apply mask. 
    <p></p>
  </li>
</ul>

<h3>Changes in version 3.7.52.9.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash for MetaSL shaders using <code>Spectrum</code> type.</li>
  <li>For MetaSL shaders, added support for input initializers with direct
    state variable assignments (like <code>input: a = normal;</code>). Note
    that in this version such initializers may overwrite the explicit (not
    connected) value for parameters provided by mental ray API / .mi
  syntax.</li>
  <li>For MetaSL shaders, added support for default-to-state annotations.
    Note that this mechanism is deprecated, support for shader parameter
    initializers will follow.</li>
  <li>For MetaSL CIL backend, fixed possible running out of memory crash if a
    large number of shaders need to be compiled.</li>
  <li>For MetaSL CIL backend, fixed broken code generated for matrix
    constructors.</li>
  <li>For MetaSL compiler, fixed broken code produced for struct input
    parameters containing textures.</li>
</ul>

<h3>Changes in version 3.7.52.8</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multihosted rendering, fixed possible odd warning on unfreezing
    camera.</li>
</ul>

<h3>Changes in version 3.7.52.7</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For Image Based Lighting (IBL), added new string option
    <code>"environment lighting shadow"</code>. Possible values are: 
    <ul>
      <li><code>"off"</code>: no visibility tests, no shadows from the
        environment,</li>
      <li><code>"solid"</code>: all objects (including
        transparent/semi-transparent ones) cast solid shadows,</li>
      <li><code>"transparent"</code>: support for transparent and
        semi-transparent objects.</li>
    </ul>
    <p>The default value is <code>"transparent"</code>. Earlier versions of
    mental ray follow the <code>"solid"</code> option. Rendering with
    <code>"solid"</code> option is slightly faster.</p>
  </li>
  <li>For MetaSL shaders, <code>fmod</code> function for integers has been
    deprecated. Replaced it with <code>operator%</code>.</li>
  <li>The default value of the registry
    <code>{_MI_REG_METASL_EMULATE_MI_PHEN}</code> introduced in version
    3.7.52.0 to convert MetaSL phenomena into mental ray phenomena for usage
    with precompiled shaders has been changed to false.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For builtin architectural material BSDF, fixed too low reflections
    under the Fresnel layer.</li>
  <li>For MetaSL shaders, fixed usage of info,warning,error functions in free
    (non-shader) functions.</li>
  <li>For MetaSL shader light loops, the <code>get_light_parameter()</code>
    function returned true even if the parameter did not exist. Fixed.</li>
  <li>For MetaSL shade light loops, pass light direction properly.</li>
  <li>For MetaSL shaders, fixed a regression in shadow shaders: the
    transparency value was taken as a result instead of applying it as
    multiplier.</li>
  <li>For precompiled MetaSL shaders, fixed generation of shader declarations
    with no inputs.</li>
  <li>For precompiled MetaSL shaders, fixed generation of shader declarations
    with inputs in <em>"float a, b;"</em> style.</li>
  <li>For MetaSL shaders, fixed compilation of implicit texture to boolean
    conversion.</li>
  <li>For MetaSL CIL shaders, fixed wrong code generated for assignments to
    vector elements selected by indexing.</li>
  <li>For MetaSL shaders compiled to C++, fixed possible broken generated C++
    code in array initialization.</li>
  <li>For MetaSL compiler, fixed possible crash when an input parameter was
    declared as an unsized array with no initializer.</li>
  <li>Fixed some memory leaks in MetaSL compiler.</li>
</ul>

<h3>Changes in version 3.7.52.5</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Improved error reporting for MetaSL phenomena.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multi-hosted rendering of scenes with BSP2 accelerations, fixed
    possible crash in rendering of second and subsequent frames.</li>
  <li>On Windows platforms: for multi-hosted rendering of scenes with BSP2
    acceleration, fixed possible freeze in rendering of second and subsequent
    frames.</li>
  <li>Fixed a crash if photon map diagnostic was used in combination with
    <code>-photonmaps only</code> command line option or the corresponding
    rendering mode for integrated versions.</li>
  <li>For precompiled MetaSL shaders, fixed normal connection for bump
    shaders.</li>
  <li>For MetaSL shaders running in precompiled mode, fixed a crash for
    phenomena having multiple outputs.</li>
</ul>

<h3>Changes in version 3.7.52.4</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Improved performance and scalability of progressive rendering.</li>
  <li>For MetaSL shaders, improved support for ray type.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For ccmesh objects, improved possible artifacts originated from
    insufficient numerical prevision of derivatives.</li>
  <li>Fixed double contribution of the environment lighting if finalgather
    and IBL has been enabled.</li>
  <li>For progressive rendering, fixed wrong broken handling of events.</li>
  <li>For MetaSL BSDF shaders, avoid shooting unneeded rays in the rendering
    kernel.</li>
  <li>For MetaSL compiler, fixed several bugs in MetaSL phenomena, including
    crashes of loading of some <code>.xmsl</code> files.</li>
  <li>Fixed initialization of arrays inside of MetaSL phenomena. This affects
    MetaSL internal nodes only, mental ray shader parameters do not support
    initializers.</li>
</ul>

<h3>Changes in version 3.7.52.3</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For high resolution images rendered with finalgather, substantially
    reduced the amount of continuous memory needed by multi-pass finalgather
    precomputation. This allows for bigger images to be rendered if memory is
    fragmented.</li>
  <li>For MetaSL shaders, MetaSL shader parameters of type
    <code>float2</code> are now mapped to mental ray API parameter type
    <code>miVector</code>. <code>float4</code> maps to <code>miColor</code>.
    <code>int2/3/4</code> and <code>bool2/3/4</code> map to
    <code>miVector</code> (for 2 and 3 values) and <code>miColor</code> (4
    values), respectively. MetaSL matrices of all types are mapped to
    <code>miMatrix</code>.</li>
  <li>In the MetaSL CIL backend, a number of missing MetaSL features have
    been implemented. This includes (but is not limited to): 
    <ul>
      <li>assignment to state variables</li>
      <li>fetching multiple outputs of a shader in a trace call</li>
      <li>texture members</li>
      <li>texture samplers</li>
      <li>ddx and ddy</li>
    </ul>
    Beyond this various bugs have been fixed, most notably in the code
    generated for swizzles, the mapping of some types and operators, and in
    the handling of implicit conversions. </li>
  <li>For precompiled MetaSL shaders, shading graph connections to normals
    and positions are now supported to allow for effects such as bump mapping
    and normal mapping.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multihosted rendering, fixed memory leaks on slave hosts that
    occurred after frame 1 in case multiple frames were rendered. When BSP
    acceleration was used, these leaks were significant.</li>
  <li>For multihosted rendering, fixed distribution of MetaSL CIL shaders. In
    order to use the CIL backend, all slaves hosts must run under Windows.
  </li>
  <li>In the MetaSL compiler, fixed a possible memory corruption which
    occurred in multihosted network rendering, or debug versions of the
    compiler.</li>
</ul>

<h3>Changes in version 3.7.52.2.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For MetaSL shaders, added support for Lambert BSDF.</li>
  <li>For the API consistency reasons, renamed classes called
    <code><em>Type</em>_access</code> resp. <code><em>Type</em>_edit</code>
    to <code>Access_<em>type</em></code> resp.
    <code>Edit_<em>type</em></code>. Corresponding typedefs are provided for
    compatibility.</li>
  <li>In debug version of mental ray: for MetaSL CIL backend, generate
    debugging information.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible shadow artifacts in Image Based Lighting (IBL).</li>
  <li>For MetaSL compiler, fixed missing arguments casts in constructors, in
    particular <code>Color(0, 0, 0, 1)</code> is fixed.</li>
  <li>For MetaSL compiler, implemented missing % (mod) operator.</li>
  <li>For MetaSL shades the glossy component for direct_light function has
    been computed without testing the occluders of the environment,
  fixed.</li>
  <li>For MetaSL CIL backend, fixed texture samplers with filtering. Fixed
    several further issues.</li>
  <li>Platform specific: on Linux platforms, no longer link libgcc
    statically. This has caused crashes in exception handling of MetaSL
    compiler for some cases then Linux distribution where mental ray has been
    compiled and executed were different.</li>
</ul>

<h3>Changes in version 3.7.52.0.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Introduce C++ API for Catmull-Clark mesh subdivision surface geometry
    for access and manipulation from shaders. The interface is provided in
    the new header file <code>shader_sds34.h</code> which is automatically
    included by <code>shader.h</code> when using C++ compilers.</li>
  <li>Reduce peak memory consumption for finalgather progressive preview.</li>
  <li>Performance improvement in the progressive rendering mode to achieve a
    desired quality in less time.</li>
  <li>Add motion blur to be rendered in progressive mode.</li>
  <li>For MetaSL shader graphs and phenomena provided in <code>.xmsl</code>
    files, added support for constructing the actual phenomenon in mental ray
    instead of compiling it into a single mental ray shader. This allows to
    support MetaSL phenomena that are built externally (like in mental mill)
    but rendering with shader nodes which have been pre-compiled (from native
    or MetaSL source code) and pre-loaded into mental ray. This feature
    explicitly avoids runtime compilation of MetaSL shaders or phenomena.
    Note, that <em>this behavior is enabled by default</em>. It can be
    disabled defining the registry key
    <code>{_MI_REG_METASL_EMULATE_MI_PHEN}</code> and setting its value to
    <code>off</code>. </li>
  <li>For MetaSL shaders, implement support for conditionals on scalars and
    vector values expressions.</li>
  <li>For MetaSL shaders, implemented <code>Texture_info</code> class.</li>
  <li>For MetaSL CIL backend, implement support for shadowing from MetaSL
    light shaders.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fix a bug leading to crashes when using multiple finalgather map
  files.</li>
  <li>For MetaSL CIL backend, fix problems when accessing files in temporary
    directories with a name that contains spaces.</li>
  <li>For MetaSL support, fix recognition of registry keys together with
    their actual values.</li>
  <li>For MetaSL CIL backend, fix more bugs in code generation on both 32bit
    and 64bit reducing the potential for CIL compilation errors or .NET
    runtime crashes. </li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For architectural material shaders, avoid artifacts when using
    anisotropic effect in extreme conditions by raising accuracy of
    computations.</li>
  <li>For architectural material shaders, fix uninitialized output values
    leading to false color artifacts in certain cases.</li>
  <li>For production shaders, fix display order of finalgather shooters to be
    top-left-to-bottom-right.</li>
</ul>

<h3>Changes in version 3.7.51.0.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Add new command line option <code>-progress_frequency n</code> and
    remove former support for an optional second argument to
    <code>-verbose</code>. This option allows to control the frequency of
    percentage progressive messages. For example, <code>-verbose 5
    -progress_frequency 10</code> command line would result in printing
    progress messages for approximately each 10 percent.</li>
  <li>On Windows platforms, remove temporary cached framebuffer files is ray
    executable is killed.</li>
  <li>For MetaSL shaders, implemented support for BSDFs (BRDFs).</li>
  <li>For MetaSL shaders, implement proper support for ray types in trace
    functions.</li>
  <li>For MetaSL shaders, improve performance for frequent access to shader
    states.</li>
  <li>For MetaSL CIL backend, implement support for unary operators.</li>
  <li>For MetaSL CIL backend, implement support for various texture lookup
    functions.</li>
  <li>For MetaSL CIL backend, implement support for missing transformation
    functions.</li>
  <li>For MetaSL shaders, re-enabled message passing across trace() and other
    functions, which has been temporarily disabled in version 3.7.50.10.</li>
  <li>For MetaSL shaders, enabled message passing for light loops.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Reduced the memory consumption for final gather progressive preview.
  </li>
  <li>Fixed return value of query <code>miQ_NUM_TEXTURES</code> for hair
    objects with placeholders.</li>
  <li>Fixed possible crash if a phenomenon evaluation was attached to a BSDF
    slot. In particular, this could be the case when BSDFs were used in
    combination with Irradiance Particles.</li>
  <li>For MetaSL shaders, fixed tracing a ray done instead of environment
    lookup if <code>trace</code> function was called with environment ray
    type.</li>
  <li>For MetaSL shaders, fixed shader compilation error if variable length
    array parameter was used.</li>
  <li>For MetaSL shaders used as shadow shaders, fixed a crash in MetaSL
    shader with <code>"transparency"</code> parameter of type float was
  used.</li>
  <li>For MetaSL CIL backend, fix various bugs in code generation reducing
    the potential for CIL compilation errors or .NET runtime crashes. </li>
  <li>For MetaSL CIL backend, fixed shader compilation if temporary directory
    file name contained spaces.</li>
</ul>

<h3>Changes in version 3.7.50.15.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>In the debug executables on Windows, changes the implementation of
    miASSERT to allow to continue execution past the assert point.</li>
  <li>For the progressive finalgather precomputation of images with large
    resolution, significantly reduced the amount of memory used for temporary
    structures.</li>
  <li>For OpenEXR files, changed channel names used to save normal and motion
    vector framebuffers to NX/NY/NZ and MX/MY/MZ. Previously used name "Y"
    did not follow the recommendation and confused many viewers for being
    intensity.</li>
  <li>Improved performance of the Quasi-Monte-Carlo sampler generator. The
    sample patterns are not changed. 
    <p>Known issue in this version: photon emission from some type of lights
    may fail leading to "no photons emitted" error (fixed in 3.7.50.16).</p>
  </li>
  <li>For MetaSL shaders, improve error handling by printing symbolic names
    instead of numeric ids for unsupported state/camera/frame variables. If
    unsupported normal derivatives are accessed, return zero as approximation
    instead of printing warnings.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the BSP2 acceleration used in combination with motion blur with
    multi-segment moving geometry, fixed possible artifacts due to improper
    computation of the motion segment time interval.</li>
  <li>For non-rasterizer rendering modes, clean up the opacity used by
    <code>mi_opacity_get</code> function for each sample.</li>
  <li>For MetaSL shaders, support enabling/disabling environment
  properly.</li>
  <li>For MetaSL CIL backend on 64-bit Windows, generate 64-bit shader
    libraries instead of 32-bit ones.</li>
  <li>For MetaSL CIL backend, fixed light iterators.</li>
  <li>For MetaSL CIL backend, implemented missing array support.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For architectural, paint, production, subsurface and base shaders,
    <code>miState::importance</code> is now used consistently instead of the
    <code>miIM</code> key for
    <code>mi_shaderstate_set/mi_shaderstate_get</code> functions. This
    provides interoperability with MetaSL shaders and improves performance
    slightly.</li>
  <li>Improved performance of the <code>mip_matteshadow</code> shader by
    avoiding unnecessary <code>mi_flush_cache</code> calls.</li>
  <li>For the mip_matteshadow shader fixed possible finalgather light leak
    artifacts by using an individual id in order to restrict the finalgather
    map lookup ( <code>miIrrad_options</code><code>::id</code> has been
    introduced in version 3.7.50.4).</li>
</ul>

<h3>Changes in version 3.7.50.14.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the Image Based Lighting (IBL) introduced in version 3.7.50.11,
    allow to access the build-in environment light by the name
    "<code>builtin_light_env_inst</code>". This allows to use IBL in the
    explicit light lists.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible crash if <code>miRC_TO_SPIRAL</code> rendering tile
    order was used. Regression in version 3.7.50.11.</li>
  <li>For MetaSL CIL backend, fixed enumerations and structs.</li>
</ul>

<h3>Changes in version 3.7.50.13.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For lens shaders used with the rasterizer, initialize
    <code>miState::point</code>, <code>miState::dist</code> and
    <code>miState::dir</code> according to the closest hit the closest
  hit.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL CIL backend, fixed crash in compilation of shaders with no
    input parameters.</li>
  <li>For MetaSL CIL backend, fixed LHS (left hand side) swizzles.</li>
</ul>

<h3>Changes in version 3.7.50.12.</h3>

<p>Known limitation is this version: MetaSL CIL backend can crash for shaders
with no input parameters, fixed in 3.7.50.13.</p>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Changed the license scheme for multi-core CPUs. The limit of 2 or 4
    cores per CPU is removed.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a crash in the integrated versions of mental ray using mental ray
    3.5 compatibility framebuffer interface. Regression in version
  3.7.50.9.</li>
  <li>Fixed possible infinite recursion in the error handline of broken PNG
    images.</li>
  <li>For MetaSL CIL backend fixed static functions, fixed component
    selection and swizzling on vectors.</li>
</ul>

<h3>Changes in version 3.7.50.11.</h3>

<p>A temporary CIL backend usage example has been added to
<code>common/doc/tutorials/metasl_cil_backend</code>.</p>

<p><strong>New features:</strong></p>
<ul>
  <li>Built-in Image Based Lighting (IBL). 
    <p>Though image base lighting is implemented in some of OEM shader
    packages, built-in solution is more efficient and does not require
    efforts to be invested atop of mental ray kernel to develop corresponding
    shaders.</p>
    <p>IBL can be enabled by setting the string option "<code>environment
    lighting mode</code>" to the value "<code>light</code>" (further modes
    will possibly be made available in the future). The <code>"environment
    lighting quality" &lt;float&gt;</code> string option with a floating
    value in range from 0.0 to 1.0 can be used to control the quality of the
    image, with 1.0 been the highest quality.</p>
    <p>If used, mental ray would create an internal light of a "user" type
    and use this light in the light lists according to the conventional
    lightlist inheritance rules. mental ray kernel would also presample the
    environment, create a lookup acceleration structure and use importance
    driven adaptive sampling to obtain the environment light to the scene.</p>
    <p>IBL can be combined with progressive rendering,</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For finalgather precomputations, the progress report percentage
    messages are not joined for all passes.</li>
  <li>Added new include file <code>intrinsics.xmsl</code>. For scenes using
    intrinsic MetaSL shader nodes as parts of shading trees and
    <code>.mi</code> files phenomena, this file need to be to generate
    internal intrinsic shaders declarations.</li>
  <li>The <code>mi_color_filter_lookup</code> function called on an image
    with a negative filter value would return unfiltered value of a single
    image pixel. This allows to combine unfiltered image lookup in existing
    shaders.</li>
  <li>For MetaSL shaders, added support for filter types "<code>none</code>"
    (unfiltered) and "<code>data</code>".</li>
  <li>Shader libraries specified on mental ray command line have been loaded
    before parsing of the rayrc config file, changed to take config file into
    account.</li>
  <li>For <code>mi_query</code> modes <code>miQ_GROUP_KID</code>,
    <code>miQ_GROUP_NKIDS</code>, <code>miQ_GROUP_LABEL</code>,
    <code>mIQ_GROUP_DATA</code>, and <code>miQ_MERGE_GROUP</code> check that
    the database tag passed is of the <code>miSCENE_GROUP</code> type and
    return false otherwise. This fixes potential crashes in case of
    inappropriate i_query<code>mi_query</code> usage.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Platform specific: if cached framebuffer are used, create the temporary
    file with FILE_FLAG_DELETE_ON_CLOSE flag to assure proper file deletion
    if case of application abort or crash.</li>
  <li>For mental ray library integrations, fixed a problem in memory
    management. If mental ray was running low on memory and a memory block
    allocation failed, in some cases mental ray kernel failed to call the
    application callback registered with
    <code>mi_mem_set_flush_failure_cb</code>().</li>
  <li>On Windows platforms fixed possible crash in rendering abort if
    memory-mapped or cached framebuffers were used (regression in version
    3.7.50.5).</li>
  <li>Debug version only: removed incorrect assert in rendering of some large
    scenes with BSP2 acceleration.</li>
  <li>For MetaSL C++ backend, fixed output types for shaders with multiple
    outputs.</li>
  <li>For MetaSL CIL backend, a crash in compilation of a second shader.</li>
  <li>For MetaSL CIL backend, pass shader input parameter values
  properly.</li>
  <li>For MetaSL CIL backend, fixed compilation of variable declarations of
    types <code>bool</code>, <code>int</code>, <code>float</code> and
    <code>float3</code>.</li>
  <li>For MetaSL CIL backend, fixed compilation of
    <code>Light_iterator</code> and <code>Sample_iterator</code>.</li>
  <li>For MetaSL CIL backend, fixed compilation of
    <code>Trace/Occlusion/Irradiance_options</code> and most of their
  methods.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For production shaders, added new shader
    <code>mip_rayswitch_stage</code>. It takes one of several color
    parameters named after mental ray rendering stages (tile rendering,
    finalgather precomputing, globillum/caustic photon emission, lightmapping
    etc.) and returns one corresponding to the current rendering stage.</li>
  <li>For production shaders, added new shader <code>mip_fgshooter</code>.
    This special lens shader optimizes precomputation of finalgather map for
    animation renderings that contain a camera move. For tile rendering, the
    shader just passes the <code>mi_trace_eye</code> call with no further
    effects. For the finalgathering precomputation stage though, it takes the
    array of matrices passed as parameter and applies them as camera
    transformations. When, it shots an eye ray according to each of the
    transformations. This causes the location of finalgather points (for
    static object) to be consistent across the entire animation, reducing
    flicker. The "<code>mode</code>" parameter controls for the
    pre-visualization of finalgather precomputations. For the
    <code>mode</code> value 0, views from multiple cameras are painted in the
    same image side-by-side. For the <code>mode</code> value 1, an average
    image from multiple cameras is displayed. For the <code>mode</code> value
    3, the image for the camera in the scene DAG is displayed (note that this
    mode also influences finalgather point distribution). The mode parameter
    is experimental and may change in the future versions.</li>
</ul>

<h3>Changes in version 3.7.50.10.</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Initial implementation of the MetaSL CIL (.NET) backend on Windows
    platforms. 
    <p>Integrated MetaSL compiler does not generate binary code
    representation itself: instead, the C++ backend generates C++ code and an
    external C++ compiler and linker is invoked to generate a DLL linked back
    into mental ray process. Though compilers are typically installed on
    Linux and MacOSX systems, this is not the case for Windows platforms. In
    order to avoid the requirement on the external C++ compiler with
    corresponding installation and license issues, the CIL backend is
    currently being developed.</p>
    <p>The MetaSL CIL backend generates .NET (CIL) assembly code. An external
    Microsoft .NET 2.0 (or optionally a higher version) CIL assembler
    executable is invoked on that <code>.cil</code> file and generates a
    managed code DLL. The assembler is a part of Microsoft .NET Framework
    redistributable package, so no installation of a C++ compiler is
    required.</p>
    <p>To enable CIL backend, the <code>{_MI_REG_METASL_CIL}</code> mental
    ray registry variable need to be set to any non-empty value. By default,
    the C++ MetaSL backend is used. MetaSL using CIL is supported on Windows
    platforms only.</p>
    <p>Current version is extremely incomplete and can be used for
    demonstrational and workflow experimental purposes. Only simplest shaders
    like constant color shader would work in the current version. variables
    (l In particular, integer and float type [fixed in version 3.7.50.11],
    generation of state functions (like <code>trace()</code>), writing to
    state variables (like <code>normal</code> for bump shaders), free
    functions, functions with varargs,
    <code>Trace/Occlusion/Irradiance_options</code>, structs, arrays,
    color/vector component selections and swizzles have not been implemented
    yet.</p>
    <p>Note also that the (temporary) DLL files generated by CIL backend use
    <code>__stdcall</code> linkage convention. Current version of mental ray
    does not expect this convention unless it knows that the DLL just has
    been generated by it. An attempt to load such generated file in a
    different mental ray process would cause a crash.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added a possibility to control the frequency of percentage progressive
    messages. The <code>-v</code> / <code>-verbose</code> command line option
    gets an optional second argument specifying the frequency in percent. For
    example, <code>-v 5 10</code> command line would result in printing
    progress messages for approximately each 10 percent. Note: this command
    line option has been replaced with <code>-progress_frequency n</code>
    options in version 3.7.51.0.</li>
  <li>Added function <code>mi_get_metasl_interface</code> to get new
    <code>mi::shader::Metasl_interface</code> class with API for generated
    MetaSL shaders. This API is not intended to be used by shaders written in
    C/C++. The <code>getMetaSLState</code> method of the
    <code>mi::shader::Interface</code> class is removed. This provides a
    clean separation of C/C++ and MetaSL interfaces.</li>
  <li>For the BSP2 acceleration, significantly decreased the amount of memory
    used for BSP tree construction on 64-bit machines.</li>
  <li>For the BSP2 acceleration, use the approximate number of triangles per
    object if provided by .mi file / translator. This improves BSP2
    performance vs. memory consumptions for scenes with placeholder objects
    and with a lot of objects consisting of few triangles.</li>
  <li>For MetaSL shaders, the <code>{_MI_REG_METASL_DEBUG_CPP}</code>
    registry key added in version 3.7.0.8 is disabled. Instead, the
    <code>{_MI_REG_METASL_TRACE}</code> registry key is now supporting t
    disable the removal of the temporarily generated C++/CIL files and emit
    more debug information.</li>
  <li>For <code>mi_kdtree_lookup</code> function, allow
    <code>miKdtree_lookup_callback</code> to be null, which may be useful if
    only the effective radius of the lookup is of interest.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible pyramid texture filtering artifacts in the rasterizer.
    The <code>miState::raster_x/y</code> coordinates in the lookup were 0.5
    (sub)pixel off the corresponding <code>miState::point</code>, which
    sometimes led to a wrong pyramid level selected.</li>
  <li>For OpenEXR images, fixed possible wrong image output types, such as
    single channel floating point (<code>s_fp</code>) used instead of half
    (<code>s_h</code>), as well ass <code>rgba_h</code> used instead of
    <code>rgb_h</code>.</li>
  <li>Messages from MetaSL integration are printed for "RMSL" module instead
    of "LIB".</li>
  <li>For MetaSL shaders, resolved the error message on unknown depth of
    field ("state variable 37").</li>
  <li>For malformed scenes containing light lists with instances referring to
    non-existing lights, fixed possible null tag access fatal.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For multipass rendering, fixes possible artifacts in metallic paint
    shader.</li>
</ul>

<p><strong>Known limitations in this revision:</strong></p>
<ul>
  <li>For MetaSL shaders, message passing across trace() and other functions
    has been temporarily disabled in order to unify C++ and CIL backends.
    Restored in version 3.7.51.0.</li>
</ul>

<h3>Changes in version 3.7.50.9.</h3>

<p><strong>Feature Improvements:</strong></p>
<ul>
  <li>Added <code>mi_query</code> mode <code>miQ_FUNC_PARAM_LOOKUP</code>. A
    pointer to the string (char *) containing the name of the shader
    parameter, and the type of the parameter (<code>miParam_type</code> enum)
    should be passed as varargs of <code>mi_query</code>. The result argument
    pointer of <code>mi_query</code> is initialized with the shader parameter
    value if the named shader parameter is found and the value is not
    connected to be an output from other shader.</li>
  <li>For MetaSL shaders sampling lights, implemented
    <code>get_light_parameter()</code> method.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the BSP2 acceleration, use static BSP2 trees if the shutter
    interval is zero, even if motion vectors are required.</li>
  <li>For the finalgather interpolation lookup to a restricted finalgather
    point set introduced in version 3.7.50.4, fixed the
    <code>miIRRAD_DEFAULT</code> macro to initialize the <code>id</code>
    option properly. This fixes unpredictable finalgather lookup results for
    shaders compiled with <code>shader.h</code> header file taken from
    versions 3.7.50.4 to 3.7.50.8.</li>
  <li>For finalgathering used with BSP acceleration and volumetric shaders,
    fixed possible shading artifacts due to <code>miState::dist</code> not
    initialized to zero if finalgather ray misses geometry.</li>
  <li>For OpenEXR output images specified with mental ray 3.5 output
    compatibility syntax, fixed broken compression type always set to
    "<code>rle</code>". </li>
  <li>For the SPM-protected version of mental ray: fixed possible failure to
    acquire necessary number of licenses if more than one SPM server host has
    been specified, one of the SPM servers crashes or shuts down and none of
    the other SPM servers has sufficient number of licenses so that the
    licenses need to be collected from multiple hosts.</li>
  <li>Fixed possible crash or allocation of large memory block fatal on
    loading a MetaSL shader.</li>
</ul>

<h3>Changes in version 3.7.50.8.</h3>

<p><strong>Feature Improvements:</strong></p>
<ul>
  <li>For ccmesh objects with large faces, implemented pre-splitting of such
    faces for more efficient tessellation and displacement.</li>
  <li>For MetaSL shaders, added <code>{_MI_REG_METASL_DEBUG_CPP}</code>
    registry. If set, the temporary generated C++ files are left over (the
    behavior of version 3.7.50.7 and prior), otherwise the C++ files removed.
    (Starting with version 3.7.50.10, use the
    <code>{_MI_REG_METASL_TRACE}</code> registry for this).</li>
  <li>For the progressive rendering DISP interface, no longer send frame
    end/begin event between subsequent passes.</li>
  <li>Added support for cached framebuffers in the progressive rendering
    mode. The combination is not recommended for performance reasons
  though.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For scenes with assemblies and incremental changes, fixed possible
    crash at the beginning of the second frame.</li>
  <li>Fixed possible crash in incremental changes of scenes with
  assemblies.</li>
  <li>For rendering with anisotropic BSDFs, fixed wrong orientation of
    highlights.</li>
  <li>For MetaSL shaders in windows platforms, fixed embedded manifest.</li>
  <li>For MetaSL shaders, fixed a fatal of 1D texture was used.</li>
  <li>Platform specific: on Linux in the binary echo mode fixed broken echo
    of vector data.</li>
</ul>

<h3>Changes in version 3.7.50.7.</h3>

<p><strong>Feature Improvements:</strong></p>
<ul>
  <li>For MetaSL shaders, the library paths (default and specified with the
    <code>{_MI_REG_LIBRARY}</code> registry and <code>-ld_path</code> command
    line option) are passed to the linker automatically. On Windows platforms
    it is recommended to add a path to the directory containing the
    <code>shader.lib</code> file in order to avoid specifying the full file
    name with the <code>-ld_libs</code> command line option.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed a possible crash in the integrated version of raylib.</li>
  <li>For MetaSL shader compilation, added quotes around include and link
    paths in the compiler invocation. This resolves MetaSL compilation errors
    if default installation has been applied on Windows platforms.</li>
  <li>For MetaSL shader compilation, do not protect compiler/linker command
    name with the quotes. On Windows platforms, this resolved the compiler
    invocation failure by CMD.EXE shell, which printed "The input line is too
    long" error message.</li>
  <li>For the new temporary framebuffer file handling added in version
    3.7.50.5, fixed possible cleanup failure if the rendering abort was
    handled by the net thread.</li>
</ul>

<h3>Changes in version 3.7.50.6.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed possible artifacts and NaN warnings for rendering of scenes with
    anisotropic BSDFs, such as Ashikhmin and architectural.</li>
  <li>For MetaSL shaders, fixes the scheme for temporary file names. The old
    one allowed only a limited number.</li>
</ul>

<p></p>

<h3>Changes in version 3.7.50.5.</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Added progressive rendering mode. There are two versions of this mode
    planned, for usage with mental ray conventional shaders for maximal
    compatibility with conventional mental ray rendering, and with build in
    BSDFs for maximal performance / fastest response. 
    <p>This version of mental ray enables the mental ray shader compatible
    mode. This mode is compatible with finalgathering (in particular, with
    progressive finalgather precomputation), photon mapping and other
    techniques.</p>
    <p>In the progressive mode, samples are placed sparsely (few samples per
    pixel or even one sample for several pixels), and the result is displayed
    immediately if an interactive display using the DISP protocol is
    attached. For the fastest response times, the first pass is usually
    computed with less than 1 sample per pixel. Additional samples are
    computed in the subsequent passes and the accumulated framebuffer tile is
    re-displayed interactively.</p>
    <p>User may decide to stop rendering once the desired quality is
    reached.</p>
    <p>Progressive mode can be enabled with the string option
    <code>"progressive" on</code>, or with the command line option
    <code>-progressive on</code> (default: off).</p>
    <p>The <code>"progressive max samples"</code> <code>&lt;int&gt;</code>
    string option and <code>-progressive_max_samples &lt;int&gt;</code>
    command line option can be used to specify the number of samples per
    pixel after which rendering will stop automatically.</p>
    <p>The <code>"progressive subsampling size" &lt;int&gt;</code> string
    option and <code>-progressive_subsampling &lt;int&gt;</code> command line
    option (default: 1) can be used to specify the sample density in several
    initial passes. If set to N, approximately one sample for each N*N pixel
    tile per pass will be used.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the BSP2 acceleration, avoid loading placeholder objects during
    construction of the initial master BSP tree.</li>
  <li>For the BSP2 acceleration, added dynamisation of memory consumption for
    large scenes. More compact (but slower for intersection test)
    representation of the triangle trees is enabled once there is a mental
    ray scene database flush for the given frame.</li>
  <li>Added support for BSDFs in for the Irradiance Particles algorithms. In
    the current version, the underlying model for diffuse interaction is
    always lambertian. Using BSDFs give a moderate performance improvement
    due to the significantly reduced number of shader calls. BSDF
    translucency (diffuse transparency) is supported, however the classical
    transparency is not. The BSDFs are used automatically if attached to the
    material slot.</li>
  <li>Adds new mi_query mode miQ_BUMP_BASIS, which computes bump basis
    vectors at the current intersection point. The <code>miState</code>
    parameter should be current intersection state, and the tag parameter
    should be 0. If the result out parameter is zero, the bump vectors are
    calculated and stored in the <code>state-&gt;bump_x/y_list</code>. If
    result out parameter is not 0, it should point to a
    <code>miVector[2]</code> array (6 floats), and the fifth argument
    specifying the texture space should also be provided. The result array is
    filled with the bump basis in addition to
    <code>state-&gt;bump_x/y_list</code> in that case.</li>
  <li>For integrations of raylib: added two new <code>mi_rc_run_query</code>
    modes <code>miRCQ_DISP_NET_PORT</code> and
    <code>miRCQ_DISP_TALK_PORT</code>. The output result parameter of the
    function should be a pointer to <code>int</code>. It is filled with the
    port used by mental ray for the DISP net (used bu imf_disp utility) and
    DISP talk interactive display protocols respectively. (Note: mental ray
    uses the same port ids for TCPv4 and TCPv6 protocols).</li>
  <li>The DISP talk protocol has been extended with the command "stop". This
    command is intended to be used with standalone mental ray application and
    results in mi_par_abort call for the conventional rendering, resp. in
    stopping rendering of further tiles and writing out of the images
    rendered so far in the <strong><code>progressive</code></strong>
    rendering mode described above.</li>
  <li>For the imf_disp utility on Linux and Windows platforms a "Stop
    Rendering" menu item has been added. If selected, imf_disp sends the
    "stop" command for the current rendering of the image being
  displayed.</li>
  <li>On Unix/Linux platforms, improved cleanup of temporary framebuffer
    files in case of mental ray killing/crashing: the temporary files are
    kept open but unlinked immediately, leading to the automatic removal by
    the file system. 
    <p><code>FILE_FLAG_DELETE_ON_CLOSE</code> flag is also added on Windows
    platforms, however it is less reliable.</p>
  </li>
  <li>For raylib integrations, added API functionality for MetaSL shaders (in
    addition to the $include instruction in .mi files): 
    <ul>
      <li><code>miMetasl* mi_api_metasl_begin(char *name)</code> begins
        MetaSL shader block declaration. The <code>name</code> parameter is
        API name of the metasl code block.</li>
      <li><code>miBoolean mi_api_metasl_filename(char filename*)</code>
        instructs mental ray kernel to take the MetaSL code from the
        specified file.</li>
      <li><code>miBoolean mi_api_metasl_code(char code*)</code> instructs
        mental ray to treat the code string as MetaSL code.</li>
      <li><code>miTag mi_api_metasl_end(void)</code> finishes the MetaSL code
        and adds it the the mental ray database. The tag returned is the
        named API tag for the block. </li>
    </ul>
    Known limitation: deletion of the MetaSL code block is not fully
    functional. </li>
  <li>For MetaSL shader developers: added the registry
    <code>{_MI_REG_METASL_TRACE}</code>. If its value is set, mental ray will
    print verbose information for MetaSL shader generation useful for
    debugging purposes.</li>
  <li>For MetaSL shaders, implemented one and three-dimensional texture
    samplers.</li>
  <li>For MetaSL shaders, added support for the light space.</li>
  <li>For MetaSL shaders, implemented IES/Eulumdat light profiles.</li>
  <li>For MetaSL flattened shading graphs coming from mental ray, fixed
    structure member output connectivity.</li>
  <li>Modified policy for caching memory mappable textures. Large, tiled or
    different endian/image type .map textures were already cached (not memory
    mapped). For other .map textures memory mapping used in the beginning of
    the rendering switched to texture caching after a specific texture was
    flushed and remapped 3 times. The new policy is to switch to texture
    caching for <em><em><strong>all</strong></em></em> .map textures after
    the first mental ray database flushing for the current frame. (Note:
    filtered .map textures with no pyramids in the file are still loaded into
    memory).</li>
  <li>Improved performance of searching for files in the path list.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the BSP2 acceleration, fixed possible artifacts or crashes due to
    wrong triangle indices used in scenes with multiply-instanced objects
    containing large number of triangles.</li>
  <li>Put some of the memory blocks in BSP2 acceleration and Irradiance
    Particles under mental ray memory management / statistics.</li>
  <li>For ccmesh objects with displacement, apply vertex displacement for the
    estimation of subdivision level to be used. This solves possible shading
    artifacts for object areas close to the camera plane.</li>
  <li>Fixed possible crash for scenes with assemblies when incremental
    changes have been applied to the scene.</li>
  <li>Removed unintended dependency of caustic photon map on importon map.
    This improves the visual quality of caustics.</li>
  <li>Fixed a file descriptor leak in scenes using IES or Eulumdat light
    profiles. For scenes with many or with changing lightprofiles this could
    cause severe problems due to running out of file descriptors.</li>
  <li>For MetaSL shaders, fixed possible artifacts due to wrong default
    parameter values used.</li>
  <li>Fixed echo of default shader parameter values for parameters declared
    textually after an array one.</li>
  <li>Fixed broken echo of object faces.</li>
  <li>For the new progressive finalgather precomputation, fixed possible
    artifacts due to improper placement of adaptive points. The amount of
    jittering is slightly increased to improve the distribution quality.
    Fixed progressive visualization artifacts on the edges of pseudo-tiles.
    Fixed intensity artifacts for pseudo-tiles showing both objects with
    diffuse material and background environment.</li>
  <li>For the new progressive finalgather precomputation, fixed statistic
    info messages.</li>
  <li>For the new progressive finalgather precomputation, fixed possible
    missing DISP tiles due to a wrong number of tiles expected.</li>
  <li>For the new progressive finalgather precomputation, fixed possible
    crash for rendering second and subsequent frames.</li>
  <li>Platform specific: on Windows (32 and 64 bit), the vararg argument for
    <code>mi_query</code> mode <code>miQ_TEXTURE_DIM</code> has not been
    passed properly to the kernel, which caused crashes on 64-bit platforms.
    Fixed.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>The base shader <code>mib_illum_ward_deriv</code> is extended to
    support derivatives on all geometry types, using "bumps" (texture
    derivatives) if available for NURBS and polygonal surfaces and surface
    derivatives for subdivision surfaces and NURBS. The source code of the
    <code>get_derivs()</code> function is a recommended illustrative example
    for shader writers.</li>
</ul>

<h3>Changes in version 3.7.50.4.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Multi-pass finalgather precomputation visualization has been
    implemented. 
    <p>The finalgather precomputation image report can be enabled with the
    <code>-finalgather_display on</code> command line option or with the
    <code>miRENDER_DISPLAY_FG</code> bit in the rendering mode mask. Unlike
    in mental ray 3.7 and prior, the computation is split into several
    passes, each one refining the previous ones. The finalgather
    precomputation <em>respects the order of tile computations</em> specified
    with <code>mi_rc_set_taskorder()</code> function call.</p>
    <p>The number of FG precomputation passes can be specified with the
    string option <code>"<code>finalgather passes</code></code>", or with the
    command line option <code>-finalgather_passes &lt;int&gt;</code>. The
    default value is 3. </p>
    <p>In the current implementation, the maximal value of finalgather passes
    is 8. Only 2 most recent one apply adaptivity in the raster sampling, the
    purpose of others is to provide progressive rendering report. I.e. for
    the number of passes larger or equal to 3 the final image does not
    change.</p>
    <p>For compatibility with mental ray 3.7 and prior, single pass
    finalgather progressive display can be enabled with the string option
    <code>"finalgather precomp legacy"</code>.</p>
  </li>
  <li>For finalgathering, implemented a way to restrict finalgather map
    lookup to a specified subset of finalgather points. 
    <p>In particular, this feature may be used for rendering of objects with
    multiple semi-transparent surfaces where explicit separating of layers is
    more efficient than limiting interpolation distance or increasing the
    density of the finalgather map.</p>
    <p>The <code>miIrrad_options</code> structure passed to
    <code>mi_compute_avg_radiance()</code> function has been extended with
    the integer field <code>"id"</code>. The default value for id is zero.
    The id is stored with each finalgather point. For interpolation, the id
    passed to the interpolation call is taken into account: if zero, all
    finalgather points are potentially accepted. If non-zero, only
    finalgather points with the same id are accepted.</p>
    <p>Backwards and forwards binary compatibility of mental ray shaders and
    finalgather map files is maintained.</p>
  </li>
  <li>For the imf_disp tool, added <code>-layer &lt;name&gt;</code> command
    line option for displaying of OpenEXR files. When rendering OpenEXR
    images containing multiple framebuffers, mental ray stores framebuffer
    images in channels called <code>&lt;framebuffer name&gt;.R</code>,
    <code>&lt;framebuffer name&gt;.G</code>, <code>&lt;framebuffer
    name&gt;.B</code> and <code>&lt;framebuffer name&gt;.R</code>. In order
    to display one of those framebuffer images, the <code>&lt;framebuffer
    name&gt;</code> without suffix could be used with the <code>-layer</code>
    option.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For MetaSL shader compilation on Windows, remove manifest files form
    the temporary directory.</li>
</ul>

<h3>Changes in version 3.7.50.3</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For multiply-instanced objects inside of assemblies, share the
    tessellated geometry for non-view-dependent objects. Note that sharing
    objects need to be a part of the same assembly.</li>
  <li>Added new carpaint BSDF with the arguments as below: 
    <pre>declare shader color "builtin_bsdf_carpaint" (
    color       "base_color"       default 1 0 0 1,
    color       "reflectivity0"    default 0.1 0.1 0.1 1,
    color       "reflectivity90"   default 0.3 0.3 0.3 1,
    scalar      "fresnel_falloff"  default 5,
    scalar      "metallic"         default 0.3,
    color       "metallic_color"   default 1 1 1 1,
    scalar      "metallic_falloff" default 8,
    color       "edge_color"       default 1 0 0 1,
    scalar      "edge_falloff"     default 2,
    scalar      "unit_scale"       default 1,
    scalar      "sparkle_weight"   default 0.05,
    scalar      "sparkle_falloff"  default 1,
    integer     "mode",
    array light "lights")
end declare</pre>
  </li>
  <li>For MetaSL shader compilation, the MI_DLL_IMPORT define on the compiler
    line is not longer required, moved to the include headers. The RAY define
    is no longer used and is removed.</li>
  <li>For MetaSL shaders compiled on Windows platforms, include manifest file
    into the compiled DLLs. This may be necessary when the compiler version
    installed on the user system differs from one used to build mental
  ray.</li>
  <li>For MetaSL shaders, the C++ compilation and linkage is now done on
    demand. For shader declaration, parsing and analysis of the MetaSL source
    code is done when MetaSL file is loaded.</li>
  <li>For network rendering, compilation of the MetaSL shaders on the
    slave/satellites is enabled.</li>
  <li>Work in progress: for shading trees defined in mental ray scene files,
    implemented the first version on the shading tree flattening, which
    combines shaders by connecting parameters, and compiles the composite
    shader. The flattening is possible for shading trees and mental ray
    phenomena completely consisted of MetaSL shaders (i.e. no mixture with
    C/C++ shaders). The flattening can be enabled by setting the
    <code>{_MI_REG_METASL_FLATTEN}</code> registry to a non-empty value. 
    <p><strong>Known limitations in this version:</strong></p>
    <ul>
      <li>In the current version, the feature is provided to the compilation
        testing only. mental ray kernel does not call the flattened shaders
        <strong>(Fixed)</strong>.</li>
      <li>Textures are not supported for the flattened shaders yet
        <strong>(Fixed)</strong>.</li>
      <li>Flattened shaders are compiled immediately, not on demand
        <strong>(Fixed)</strong>.</li>
    </ul>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For OpenEXR headers, fixed possible crash when reading images of types
    <code>a</code>, <code>a_h</code>, <code>a_fp</code>, <code>m</code>,
    <code>n</code> and <code>z</code>.</li>
  <li>Export <code>mi_api_get_assembly_root</code> function properly for
    geometry shaders.</li>
  <li>For MetaSL shaders, apply include search path for the includes from
    MetaSL (.msl/.xmsl) files.</li>
  <li>For MetaSL shaders: command line used for compiler and linker
    invocation has been limited to 512 bytes, fixed.</li>
  <li>For MetaSL shaders: use state of the art compiler and linker options on
    MacOSX platforms.</li>
  <li>For MetaSL shaders, do not echo derived shader declarations.</li>
</ul>

<h3>Changes in version 3.7.50.2</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the BSP2 acceleration, added functionality to reduce allocation of
    large amount of memory during the construction of the BSP2. For large
    scenes this may prevent mental ray from running out of memory for
    geometry where the kernel heuristic estimating the number of triangles in
    a voxel fails by an order of magnitude.</li>
  <li>Removed dependency of the MetaSL shaders compiled to C++ on the
  STL.</li>
  <li>For the MetaSL shader compiled with C++ compiler on windows platforms
    for mental ray <strong>debug</strong> executables: added
    <code>/debug</code> and <code>/Z7</code> compiler/linker keys to keep the
    debug information.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For rendering of scenes with assemblies and hair, fixed possible
    missing hair artifacts.</li>
  <li>During the importon emission from the camera, avoid calling
    miCamera::volume shader. Importons need to be proceeded with photon
    volume shaders, not with a volume shader attached to the camera. In
    particular, this fixes possible empty irradiance particle map issue.</li>
  <li>For the MetaSL shader compilation added missing MI_DLL_BUILD define
    passed to the C++ compiler.</li>
  <li>For the debug version of mental ray compiled on windows platforms,
    compile shaders with <code>/MDd</code> key. This fixes the message box
    pop-up when a MetaSL shader was used with mental ray debug executable.
    Added <code>/debug</code> and <code>/Z7</code> compiler/linker keys to
    keep the debug information.</li>
  <li>Fixed a rare crash in the object splitting code coming from
    out-of-range array read.</li>
  <li>Fixed running out of memory in parsing of surfaces with very high
    number (50000) of trimming curves.</li>
  <li>Fixed several memory leaks in MetaSL compiler and its integration.</li>
  <li>Fixed a linkage errors if <code>Access_bsdf</code> was used in a
  shader.</li>
  <li>Ignore empty strings passed to the C++ compiler (an empty string cleans
    up C++ compiler include path list).</li>
  <li>For MetaSL shaders, added missing eye ray type.</li>
  <li>Fixed a crash in mental ray when writing out images of
    <code>"vta"</code>, <code>"vts"</code>, <code>"tag"</code> or
    <code>"bit"</code> types into OpenEXR files. </li>
</ul>

<h3>Changes in version 3.7.50.1</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>MetaSL compiler has been integrated into mental ray. 
    <p>If a file with <code>.msl</code> or <code>.xmsl</code> extension is
    included (<code>$include</code> statement in <code>.mi</code> file), it
    is treated as a MetaSL shader source. mental ray would read it, parse and
    convert it into the internal representation. This internal representation
    is when used to create a shader declaration and to generate shader C++
    code. The external C++ compiler and linker are invoked in that file and
    create a dynamic linked library in the directory containing temporary
    files. That DLL is when linked into mental ray.</p>
    <p>For windows platforms, it is planned to generate the
    <strong>managed</strong> code directly, which would remove the
    requirement on the C++ compiler installed.</p>
    <p>In order for C++ compilation to succeed, the C++ compiler need to be
    pointed to the include directories containing mental ray headers files
    (<code>shader.h</code> and others), as well as MetaSL C++ header files
    (root directory for <code>mi/metasl_runtime/*</code>). In order to
    simplify it, mental ray now applies the mental ray kernel include path to
    the compiler invocations automatically. I.e., the include paths may be
    specified on the mental ray standalone command line option
    <code>-I</code>, or with <code>{_MI_REG_INCLUDE}</code> registry.</p>
    <p>On windows platforms, shaders need to be linked against
    <code>shader.lib</code> or <code>ray.lib</code>. If
    <code>shader.lib</code> is not present in the compiler library search
    path, it has to be specified with <code>-ld_libs</code> and/or
    <code>-ld_path</code> command line options.</p>
    <p><strong>Known issues and limitations:</strong></p>
    <ul>
      <li>For windows platforms, it is planned to generate
        <strong>managed</strong> code for MetaSL shaders directly to avoid
        requirement of C++ compiler installed. This is work in progress.</li>
      <li>It is planned to collapse shading trees consisting exclusively of
        MetaSL shaders at compilation time, this is not fully implemented
        yet. (Partial implementation exposed in version 3.7.50.3. This is not
        a default mode in mental ray 3.7+.)</li>
      <li>Network rendering with MetaSL shaders will not work yet (fixed in
        version 3.7.50.3)</li>
      <li>Multiple MetaSL features are not or partially implemented yet
        (fixed, with few exceptions).</li>
      <li>C++ and .xmsl/.msl files are not removed from the temporary file
        directories.</li>
      <li>Unnecessary compiler invocations are done to assure functionality
        testing. This may result in reduced performance (fixed).</li>
      <li>MetaSL compiler memory is not cleaned up properly at shutdown
        (significant memory leaks fixed).</li>
    </ul>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Changed transformation inheritance for leafs inside of assemblies.
    Assembly leaf instance transformation is now multiplied properly with the
    object leaf instance transformation inside of assembly.</li>
  <li>For the command line options, <code>"-I"</code> include paths are
    passed to the C++ compiler invoked for MetaSL and C/C++ source code
    shaders. If multiple <code>-I</code> command line options are passed to
    the compiler, they are concatenated into semicolon separated list, which
    corresponds to the intuitive behavior. mental ray 3.7 and prior replaced
    the old command line option with a new one.</li>
  <li>For compilation of shaders on windows platforms, it is no longer
    required to add WIN_NT define to the C/C++ compiler invocation.</li>
  <li>Changes the order of temporary directory lookups. The environment
    variables TMPDIR, TMP, TEMP are checked in that order. If not set, the
    current directory is used on Windows, and /usr/tmp is used on other
    platforms.</li>
  <li>On Windows, temporarily created object and DLL files contains now the
    process id to avoid possible conflicts from several mental ray processes
    running on the same machine.</li>
  <li>Added string option <code>"finalgather normal tolerance"</code>. It
    specifies the maximal angle in degrees up to which a finalgather point
    normal may deviate from the surface normal for the finalgather point to
    be considered for interpolation. 
    <p>If the string option is not present, or exceeds its valid range of
    0-90 degrees (exclusive of 0 and 90), the built-in default of 25.842
    degrees is used to maintain backwards compatibility.</p>
  </li>
  <li>Added a progress percentage message for optimization of Irradiance
    Particle maps with large number of particles.</li>
  <li>Added compatibility version of the architectural BSDF. Its
    functionality is the same as for the
    <code>builtin_bsdf_architectural</code>, but the declaration follows
    those of the architectural material. </li>
  <li>Enabled <code>builtin_bsdf_architectural</code> and
    <code>builtin_bsdf_mirror</code> BSDFs with the declarations as below: 
    <p></p>
    <pre>declare shader color "builtin_bsdf_architectural" (
    color       "diffuse_refl"           default 0 0 0 1,
    scalar      "diffuse_refl_scalar"    default 1,
    scalar      "diffuse_dev",
    color       "specular_refl"          default 0 0 0 1,
    scalar      "specular_refl_scalar"   default 1,
    scalar      "refl_gloss"             default 1,
    boolean     "metal_material"         default on,
    color       "specular_trans"         default 0 0 0 1,
    scalar      "specular_trans_scalar"  default 1,
    scalar      "trans_gloss"            default 1,
    color       "diffuse_trans"          default 0 0 0 1,
    scalar      "diffuse_trans_scalar"   default 1,
    scalar      "anisotropy",
    scalar      "anisotropy_rotation",
    integer     "mode",
    array light "lights")
end declare
 </pre>
    <pre>declare shader color "builtin_bsdf_mirror" (
    color       "reflection"             default 0 0 0 1)
end declare</pre>
    <p>The <code>builtin_bsdf_architectural</code> is a simplification of the
    architectural material, containing the parameters relevant for the
    material properties. The <code>builtin_bsdf_mirror</code> is a simple
    specular reflection, which multiplies the reflected color with the
    <code>reflection</code> parameter.</p>
  </li>
  <li>The <code>mi_ambient_occlusion</code> function behavior has been
    slightly modified. When the number of cache points in the
    <code>miAmboccl_options</code> argument structure passed to the function
    is 0, the cache is ignored and the ambient occlusion value is computed.
    Negative cache points value (default: -1) still can be used to take the
    number of cache points from the global <code>"ambient occlusion cache
    points"</code> string option.</li>
  <li>Added support for displacement of primlist objects with no vertex
    normals specified.</li>
  <li>Added <code>A_H</code> and <code>S_H</code> image types to represent
    alpha and intensity images in half float resolution.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For scenes with multiply-instanced assemblies, fixed motion
    transformations.</li>
  <li>For scenes with multiply-instanced assemblies, fixed view-dependent
    approximations.</li>
  <li>For scenes with multiply-instanced assemblies, fixed displacement
    mapping inherited from a material defined on an instance in the main
    scene and inherited into the assembly.</li>
  <li>For scenes with assemblies, fixed
    <code>mi_point/vector/normal_to/from_*</code> function family. If called
    on a hit point inside of an assembly, these functions correctly use world
    space instead of the assembly local space now.</li>
  <li>For builtin BSDFs, fixed missing contribution of environment lighting
    in glossy reflections.</li>
  <li>Fixed artifacts in contour rendering used in combination with hull
    objects.</li>
  <li>Do not echo built-in BSDF shaders.</li>
  <li>For the BSP2 acceleration, fixed a regression from mental ray 3.6+ with
    memory allocations bypassing mental ray memory management. This fixes
    wrong memory usage statistics and possible crashes for large scenes not
    fitting to the memory completely.</li>
  <li>For the BSP2 acceleration, reduced effective memory consumption by
    releasing memory used for tree constructions immediately after the
    construction is finished.</li>
  <li>For the BSP2 acceleration used with motion blur, fixed possible missing
    geometry artifacts originating from numerical precision issues.</li>
  <li>For hair objects with per-hair textures, fixed <code>mi_query</code>
    mode <code>miQ_NUM_TEXTURES</code> to return correct value and avoid
    unnecessary tessellations.</li>
  <li>For the rasterizer used with motion blur, initialize
    <code>miState::time</code> properly for volumetric and environment
    shading.</li>
  <li>Fixed a possible crash if hair was used in combinations with
  assemblies.</li>
  <li>Fixed a possible crash in rendering hair with rasterizer.</li>
  <li>Fixed a possible crash and the ray library shutdown if an extremely low
    memory limit was set at startup.</li>
  <li>Fixed possible crash if Irradiance Particles were used in combination
    with BSP2 acceleration.</li>
  <li>Fixed echo of verbatim textures <code>(-echo textures</code> command
    line option) for images using with more than 8 bits per pixel per color
    channel, such as HDR.</li>
  <li>Fixed a crash in photon map diagnostic mode rendering used in
    combination with cached framebuffers.</li>
</ul>

<p></p>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For integrators, added an externally visible
    <code>mia_tonemap_api_untransform_color</code> function which may be used
    to revert the tone mapping effect.</li>
  <li>For the architectural material shader, fixed possible rare freeze in
    ambient occlusion computation.</li>
  <li>For the <code>mip_gamma_gain</code> shader, added gamma correction for
    negative numbers. In particular, this protects against possible NaN
    values.</li>
  <li>Fixed possible max version check warning for the subsurface scattering
    shader library. 
    <p></p>
  </li>
</ul>

<h3>Changes in Version 3.7.1.13.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the map containers, use shorter more expressive names for the
    classes.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multihosted rendering with integrated version of raylib, fixed
    slave host removal with the <code>mi_msg_remove_host()</code> function
    call for IPv6 addresses.</li>
</ul>

<h3>Changes in Version 3.7.1.12.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For secondary finalgather diffuse bounces, rays are traced now as
    finalgather rays and finalgather flags on objects an instances are
    respected, instead of reflection/retraction rays and flags used
  prior.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed unnecessary large number of sub-objects for polygonal objects
    with displacement presampling and large maxdisplace value specified. In
    particular, large number of subobjects resulted in slow lightmap
    rendering.</li>
  <li>For the BSP2 acceleration used with motion blur, fixed possible
    artifacts due to self-intersection precision issues.</li>
  <li>For Catmull-Clark objects, min/max subdivision levels in approximations
    were ignored, fixed.</li>
  <li>For Catmull-Clark objects, take into account shrinking when estimating
    subdivision level. This fixes unnecessary over-tessellations in such
    cases.</li>
  <li>Fixed syntax error in echoing of instance override approximation
  lists.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Make multiple-output <code>mi_metallic_paint_shader_x</code> work if
    used as an a single shader or a phenomena root.</li>
</ul>

<h3>Changes in Version 3.7.1.11.</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Add new combined approximation style for shared displacement without
    Hermite blending. The displacement approximation styles syntax includes
    now <code>"fine shared"</code>, <code>"fine nosmoothing"</code>, and
    <code>"fine shared nosmoothing"</code>. For the integrators, the
    <code>miAPPROX_STYLE_FINE_NO_SMOOTHING_CONT_DISP</code> value has been
    added to the <code>miApprox_style</code> enumeration. 
    <p>The registry <code>_MI_REG_SHARED_DISPLACEMENT</code> which could be
    used to enabled the "shared" mode globally for all objects is
    <strong>deprecated</strong>, but could be used in mental ray 3.7 for
    compatibility reasons.</p>
  </li>
  <li>For the Catmull-Clark meshes, improved texture seams quality by
    implementing spline-rule evaluation.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For Iff image file format, enable to writing out of alpha ("a")
  files.</li>
  <li>Fixed major memory leak at the end of the frame if BSP2 acceleration
    was used in combination with assemblies. Some of the acceleration
    structures have not been deleted.</li>
  <li>Fixed a memory leak if hair rendering was enabled.</li>
  <li>For raylib integrations: fixed a typo in <code>mi_par_aborted()</code>
    check which prevented application callback from been called.</li>
  <li>Options consistency: disable irradiance particles if ray tracing is
    switched off.</li>
  <li>Fixed possible crash in photon emission on scenes with assemblies.</li>
  <li>For the rasterizer, environment shaders were called with non-zero
    <code>miState::pri</code>, fixed.</li>
  <li>For ambient occlusion with enabled caching for scenes with motion blur,
    fixed visual artifacts due to computing of all ambient occlusion values
    at shutter open time.</li>
  <li>For hair objects with view-dependent approximations, set the view
    dependency flags properly.</li>
  <li>For Catmull-Clark meshes, fixed possible crash for objects with
    derivatives.</li>
  <li>Platform specific: on Windows platforms, fixed IO error reporting
    related to the image processing.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Changed the multi-output version of fast subsurface scattering shader
    <code>misss_fast_shader_x</code> to follow the same conventions as
    multi-output architectural material shader. The specular and diffuse
    properties of lights are adhered in the same way as for the architectural
    material shader.</li>
  <li>For the fast subsurface scattering shader, importance-driven sampling
    for glossy reflections has been added, which may significantly improve
    performance for some scenes.</li>
  <li>For the fast subsurface scattering shader, fixed possible artifacts
    edges of objects with very small scatter radii below 1 pixel in the
    lightmap resolution.</li>
  <li>Added new multi-output <code>mi_metallic_paint_x</code> shader
    identical to the metallic paint shader, but allowing multiple outputs
    following the architectural material conventions.</li>
  <li>Changed architectural material shader to avoid assertions in the
    <strong>debug</strong> version of mental ray due to of
    <code>mi_ward_anisglossy</code> function with inconsistent arguments. The
    change also lead to a minor performance improvement.</li>
  <li>For the production <code>mip_mirrorball</code> and architectural portal
    light <code>mia_portal_light</code> shaders, changed errors to warnings
    in accordance to the common conventions for recoverable scene issues.</li>
  <li>The architectural portal light <code>mia_portal_light</code> shader is
    made compatible with point-style area lights with no direction
  specified.</li>
</ul>

<h3>Changes in Version 3.7.1.10.</h3>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed wrong motion bounding boxes for Catmull-Clark meshes with
    multiple motions steps and no motion vectors specified.</li>
</ul>

<h3>Changes in Version 3.7.1.9.</h3>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>The shader interface is now defined in the <code>mi::shader_v3</code>
    namespace. A namespace alias for <code>mi::shader</code> is added, so
    that no changes to the shader code are required. Shader writers are
    expected to continue to use the <code>mi::shader</code> namespace. 
    <p>This fixes possible crashes (mismatched symbol linkage) if several
    debug shader libraries using different versions of
    <code>mi::shader::Access_fb</code> / <code>Edit_fb</code> were used in
    the same rendering in version 3.7.1.8.</p>
  </li>
</ul>

<h3>Changes in Version 3.7.1.8</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the shader interface, performance of the string options lookups
    (<code>mi::shader::Options::get</code>) and accessing of the framebuffers
    (<code>mi::shader::Access_fb</code> / <code>Edit_fb</code>) has been
    improved significantly. Accessing string option still includes a
    hashtable lookup, so for performance reason it is recommended to access
    them in the init shader once.</li>
  <li>For the <code>Map</code> containers, avoid rebuilding of the internal
    lookup acceleration structure when this is not necessary.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For scenes with assemblies, avoid unnecessary loading of assemblies
    with hair rendering enabled.</li>
  <li>Fixed artifacts in the shared -displacement mode enabled with the
    <code>{_MI_REG_SHARED_DISPLACEMENT}</code> registry.</li>
  <li>Fixed echoing of registries specifying kernel modifications including
    like the shared displacement trigger above.</li>
  <li>Fixed echoing of displacement approximation for polygons and
  trilists.</li>
  <li>Fixed a memory leak in the string options interface.</li>
  <li>Fixed <code>$ifeq</code> preprocessor instructions of the .mi parser
    for the environment variables.</li>
  <li>Platform specific: on Windows, fixed possible failure to save large
    photon or finalgather maps onto network drives.</li>
</ul>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>The <code>mi::shader::Interface</code> version has been increased to 3.
    Shaders compiled for mental ray 3.7 alpha versions need to be recompiled.
    Shaders compiled for mental ray 3.6/3.6+ keep the limited binary
    compatibility with mental ray 3.7 over the
    <code>mi::shader::Interface</code> version 2. </li>
  <li>For the shader interface <code>Map</code>s, fixed some const
  qualifiers.</li>
  <li>The miObject_type enumeration is changed to keep the same values as in
    mental ray 3.6+ in order to include binary compatibility with mental ray
    3.6+ (in particular, for the production <code>mip_binaryproxy</code>
    shader).</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>Improved performance of the portal light shader by avoiding multiple
    calls for insignificant lighting.</li>
  <li>Made production <code>mip_binaryproxy</code> shader compatible with
    mental ray 3.7.</li>
  <li>For <code>mia_roundcorner</code> shader, fixed possible crash if the
    shader attached to the bump parameter returned struct consisting of
    several outputs.</li>
  <li>For the architectural environment shader <code>mia_envblur</code>,
    improved the behavior of the shader in the erroneous situation of the
    parameter environment not set (meaning usage of the camera/material
    environment shader), and the share itself being set as such shader, which
    has caused recursive shader calls.</li>
  <li>For the architectural material shader, the ambient occlusion
    functionality of the shader has been changed to ignore objects not
    casting shadows.</li>
</ul>

<h3>Changes in Version 3.7.1.7</h3>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>Typedef BSDF <code>Type</code> to <code>miUint</code> to avoid possible
    incompatibilities on <code>sizeof</code>(enum).</li>
  <li>For the <code>Map</code> containers, adjusted signatures of
    <code>get</code> and <code>set</code> methods using
    <code>miMatrix</code>. This is required to as <code>miMatrix</code> is is
    typedef to <code>float[16]</code> and compiler cannot distinguish between
    reference to it and pointers for scalars on function calls.</li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Added a warning if deprecated version 1 file format used in mental ray
    version 2 and earlier is parsed.</li>
  <li>Improved robustness of geometry tessellation if corrupted geometry data
    is parsed.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For multihosted rendering, fixed possible crash at shutdown if the BSP2
    acceleration was used.</li>
  <li>Platform specific: on Windows, fixed possible failure to initialize
    library if DNS server resolved IPv6-style address lookups (like
    <code>"::1"</code>) into IPv4 addresses.</li>
</ul>

<h3>Changes in Version 3.7.1.6</h3>

<p>Tutorial on usage of irradiance particles has been added.</p>

<p><strong>New features:</strong></p>
<ul>
  <li>Added new <strong>object</strong> flag "<code>triangle estimate
    &lt;int&gt;</code>" to the .mi syntax, and the new member field
    <code>miObject::tri_est</code>. If specified this field may be set by a
    translator or exporter and give approximate number of triangles expected
    for the given object. CAD application frequently would know the precise
    number, but even if it is know only up to an order of magnitude it is
    advisable to provide it. In the future versions, mental ray will use it
    as a hint for optimizing performance and memory usage. </li>
  <li>For mental ray integration and geometry shaders API, added a new
    function 
    <p><code>mi_api_rename(char *target, char *source)</code> </p>
    <p>and corresponding .mi syntax</p>
    <p><code>rename "target" "source"</code></p>
    <p>This function may be used to rename existing scene entities without
    recreating them, in particular this may be used by application interface
    to follow user interaction.</p>
    <p>The function has following limitations:</p>
    <ul>
      <li>Renaming across scopes is not supported, by design.</li>
      <li>Compatibility with <strong>incremental</strong> echo is limited.
        mental ray kernel does not maintain list of renaming. If renaming are
        done and scene changes are echoed, application should print a set of
        rename commands as previously echoed parts of the scene may contain
        old names.</li>
      <li>API Notify callback is not called for the function.</li>
      <li>Renaming PHCR GUI is not supported.</li>
      <li>Renaming of shader declarations is possible bus discouraged as
        corresponding functions are linked using the same name as in the
        shader declaration.</li>
    </ul>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>In the displacement tessellation, the warning on removal of triangles
    of (close to) zero area is printed only once per sub-object and gives the
    number of triangles removed.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>On Windows platforms, fixed broken <code>shader.lib</code> proxy for
    shaders calling to <code>mi_scene_recreate</code> on
    <code>miSCENE_NBOX</code> type.</li>
  <li>For the standalone, fixed wrong process exit value 1. 
    <p></p>
  </li>
</ul>

<h3>Changes in Version 3.7.1.5</h3>

<p>The manual for this version has been improved.</p>

<p><strong>New features:</strong></p>
<ul>
  <li><p>Syntax and application API has been added for the Map containers
    introduced in version 3.7.1.2. </p>
    The syntax is similar to user data elements. The layout of the map can be
    declared with 
    <pre>    declare map <em>"name"</em>
        [ dim <em><em>int</em></em> , ]
        <em><em>paremeter1</em></em>,
        ...
        <em>paremeterN</em>
    end declare</pre>
    <p>with each of parameters being one of </p>
    <pre>    integer   "<em>parname</em>"
    scalar    "<em>parname</em>"
    vector    "<em>parname</em>"
    color     "<em>parname</em>"
    transform "<em>parname</em>"
    array <em>int</em> integer "<em>parname</em>"
    array <em>int</em> scalar  "<em>parname</em>"</pre>
    <p>The allowed parameter types are 32-bit integers, single precision
    floats, float 3d vectors, 4 component float colors and 4x4 float
    matrices, as well as fixed size arrays of integers and floats. </p>
    <p>For a declared layout, a map content may be specified as</p>
    <pre>    map "<em>mapname</em>" "<em>layout</em>" 
    (
        ["<em>mapfile1</em>", ... "<em>mapfileN</em>"]             |
        { &lt;<em>rec1field1</em>&gt;, ... , <em>&lt;rec1fieldM&gt;</em> }, 
        ...., 
        { &lt;<em>recKfield1&gt;</em>, ... , <em>&lt;recKfieldM&gt;</em> }
    )
    end map
 </pre>
    <p>i.e., either a list of file names containing binary map data is
    specified, or the list of fields for each particles in the map.</p>
    <p>Each <em>recSfieldT</em> entry should consist of the proper number of
    space separated float or integer values. The first record in each row
    should be N floats corresponding to the position of a particle in the
    N-dimensional map.</p>
    <p>The Map type has been added to the list of legal shader parameter
    types, following usual conventions. A Map cannot be an output of a
    shader.</p>
    <p>The equivalent API functionality is provided with the
    <code>mi_api_map_*</code> functions family.</p>
    <p>Additional documentations and tutorials will be added in upcoming
    releases.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For the BSDFs introduced in version 3.7.1.4, the BSDF component type
    has been transformed into a bitmask.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the DDS image file format, non-square images with mipmap pyramids
    were not loaded. Fixed.</li>
  <li>Fixed a crash if an <em>empty</em> photon map was loaded from a file
    and the <code>finalgather fastlookup</code> option has been enabled.</li>
</ul>

<h3>Changes in Version 3.7.1.4</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Added <strong>Bidirectional Scattering Distribution Function</strong>
    (<strong>BSDF</strong>, or <strong>BRDF</strong> for non-transmitting
    materials) support for mental ray kernel. 
    <p>In the current version, mental ray supports Lambert, Phong and
    Ashikhmin BRDFs, which are built into the kernel. Built-in shaders
    implementing these BSDFs are pre-registered in the mental ray API as:</p>
    <pre>declare shader color "builtin_bsdf_phong" (
    color       "diffuse",
    color       "glossy",
    scalar      "exponent",
    array light "lights",
    integer     "mode" )
    version     1
end declare</pre>
    <br>

    <pre>declare shader color "builtin_bsdf_lambert" (
    color       "diffuse",
    array light "lights",
    integer     "mode" )
    version     1
end declare</pre>
    <br>

    <pre>declare shader color "builtin_bsdf_ashikhmin" (
    color        "diffuse",
    color        "glossy",
    scalar       "exp_u",
    scalar       "exp_v",
    array light  "lights",
    integer      "mode" )
    version      1
end declare</pre>
    <p>Further standard BSDFs will follow.</p>
    <p>An instance of a BSDF shader with given parameters may be specified
    with the usual syntax. Input parameters of a BSDF shader can be specified
    as the result of other shaders, allowing conventional shading trees and
    phenomena to be used. The <code>miMaterial</code> structure has been
    extended with a <code>bsdf</code> slot, which may specify an instance for
    one of the BSDF shaders listed above. The .mi syntax is extended with the
    <code>bsdf</code> keyword, allowing to specify the BSDF shader in the
    material.</p>
    <p>A material shader may access the BSDF attached to the current shading
    state by using <code>mi::shader::Access_bsdf</code> class. The API for
    interaction with BSDFs is declared in the new <code>shader_bsdf.h</code>
    header file. It is described in the doxygen documentation in the manual.
    </p>
    <p>BSDFs may be split into up to 6 components (reflection and refraction,
    with diffuse, glossy, and specular components each). The
    <code>eval</code> function evaluates all BSDF components, or a subset
    thereof, for a pair of incoming and outgoing directions. The
    <code>Bsdf</code> interface also provides a <code>sample</code> function,
    which allows importance sampling of outgoing directions for a given
    incoming direction. In addition, this function provides information about
    the sampled component and the sample weight. The latter can easily be
    combined with Russian roulette for absorption, which could be used e.g.
    for writing photon shaders.</p>
    <p>A BSDF shader may be attached as material shader into
    <code>miMaterial</code>. In this case, mental ray takes care of
    simulating a material shader based on the BSDF.</p>
    <p>With BSDF shaders, it is possible to omit photon shaders. For
    materials with a BSDF shader, but no photon shader specified, mental ray
    automatically uses the BSDF shader and use its <code>sample</code>
    function to simulate photon shader behavior. For the future version, this
    fallback into BSDF will be enabled for other indirect illumination
    techniques.</p>
  </li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>Fixed <code>$ifeq</code> preprocessor instructions of the .mi parser
    using registry variables. The <code>mi_string_substitute</code> function
    applied to a string consisting of a single reference to a undefined
    registry returned the unchanged string instead of empty string.</li>
</ul>

<h3>Changes in Version 3.7.1.3</h3>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For SPM-protected version of mental ray standalone executable, added a
    boolean string option <code>-maxlics</code>. This option may be usable
    for renderfarms running multiple mental ray executables on the same
    machine. If set on, independently on how many threads are running by each
    executable, the maximal number of licenses applicable for the given
    machine is allocated and <em><strong>shared</strong></em> between all
    mental ray executables. </li>
  <li>Assure that <code>miState::dot_nd</code> initialized by intersection
    code, and the <code>dot_nl</code> parameter returned by light loop are in
    the [-1, 1] range. Small deviations were possible due to precision
  issues.</li>
  <li>For mental ray standalone executable, changed exit code to 1 if (some
    of) .mi file(s) specified on the command line is not found. If multiple
    files are specified, rendering stops after the first file missing.</li>
  <li>Restored scene extent info message at the beginning of rendering as
    known in mental ray 3.5.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For the debug build only, fixed an erroneous assert in rendering of
    shadowmaps.</li>
  <li>For rendering of lightmaps, avoid allocating of unnecessary large
    memory blocks. For objects with high number of certifies this may reduce
    memory consumption significantly.</li>
  <li>Fixed several bugs in the adaptive tessellation for Catmull-Clark
    meshes introduced in the previous version.</li>
  <li>For the finalgather automatic mode, fixed possible dark artifacts on
    objects containing finalgather points with significantly different normal
    orientations (like thin objects with indirect illumination computed on
    both sides, or on the object corners).</li>
</ul>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>The content of <code>mi_shader_if.h</code> header file now include
    several partial header files according to the features if the
    <code>mi::shader::Interface</code> class. Shader writers are still
    supposed to include the <code>mi_shader_if.h</code> file into the shader
    C++ files.</li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the architectural environment shader <code>mia_envblur</code> added
    a detection of the invalid usage of the <code>"environment"</code>
    argument pointing back to itself and for the similar case when
    <code>mia_envblur</code> shader is part of the global environment map,
    and the <code>"environment"</code> parameter is not specified, which
    efficiently resulted in self-reference. An error message is printed and
    the environment shader is disabled now.</li>
</ul>

<h3>Changes in Version 3.7.1.2</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Implemented adaptive tessellation for Catmull-Clark meshes. Each region
    can now have a different refinement level. t-vertices with neighbor
    regions having different refinement levels are fixed with triangle fans.
    Positions are always computed on the limit surface.</li>
  <li>Initial implementation of <strong><em>Map</em></strong> containers has
    been added. Maps are <em><strong>particle systems</strong></em> in N
    dimensional space. Each particle has a position and set data assigned. 
    <p>mental ray kernel provides functionality creating, accessing and
    editing of Maps, as well as loading them from files and saving them to
    files. An efficient nearest neighbor lookup functionality is implemented,
    utilizing either euclidian distance or arbitrary distance functor
    provided by user. The distance functor may implement rejections by
    returning the <code>miHUGE_SCALAR</code> value. </p>
    <p>Particle data may be any structure consisting of the common types
    including scalars, integers, vectors, colors and transforms. All
    particles in a single map have identical layout.</p>
    <p>The position of a particle is an N-dimensional float vector, where N
    varies in range from 1 to 6 in the current implementation.</p>
    <p>In this version, Maps need to be created or loaded by applications or
    shaders. API interface and .mi syntax for named Maps will be added in the
    next version. Minor modifications for the lookup interface are still
    expected. Documentation for the feature will follow. The interface
    functions can be found in the <code>mi_shader_if.h</code> file.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>For OpenEXR textures, added ability to use display window. If
    _MI_OPENEXR_WINDOW registry is set to "display" (valid values are
    "display" and "data"), the OpenEXR display window used. Note that display
    window is not compatible with mipmap pyramids for filtered local
  textures.</li>
  <li>For the integrated versions of raylib, the emergency exit for
    renderings running out of memory has been modified. The function
    <code>mi_rc_run</code> now returns to the application in one second and
    does not wait until all rendering threads are blocked. The rendering
    threads are still blocked on memory or database operations, possibly
    after <code>mi_rc_run</code> returns. Previous synchronous mode where
    <code>mi_rc_run</code> returned first after all threads get blocked was
    less robust: threads blocked on internal locks were not counted, which
    resulted in a possible application freeze.</li>
  <li>For the BSP2 acceleration, more improvements in memory consumption and
    construction time has been applied, with focus on motion blur scenes.
    Several bugs have been fixed.</li>
  <li>For string options, allow shader to access boolean values as integers.
    This is handy if shaders use variables of type <code>miBoolean</code>,
    which is typedefed to int.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For framebuffers, fixed possible crash if image file name with no
    extension was used.</li>
  <li>For scenes with assemblies, fixed flag inheritance from the main scene
    to assemblies. This resolves some cases of unnecessary loading of
    assemblies when they are not required for rendering (for example, a
    combination of assemblies visible only to shadow rays and shadow option
    set to <code>off</code>).</li>
  <li>For the <code>'{{'</code> and <code>'}}'</code> escaping for file name
    lookups introduced in version 3.6.52.5, fixed possible failure to apply
    the unescaping exactly one time.</li>
  <li>For texture caching, fixed possible issue of not releasing references
    to texture pages fast enough (slower than allocating new references) for
    large scenes with many textures and database flushing active.</li>
  <li>For OpenEXR images texture caching, fixed a possible crash for files
    with tiles not aligned the pixel coordinates origin.</li>
  <li>For multiply-instanced trilist objects with view-dependent
    displacement, fixed wrong identical displacement quality used for all
    instances.</li>
  <li>Fixed a bug where BSP2 acceleration could miss intersections if a
    substantial amount of secondary rays were spawned as children of a single
    eye ray. For cached glossy rays in the architectural material shader
    these missing intersections became visible as white dots or blocky
    artifacts.</li>
  <li>Fixed wrong motion blur for BSP2 acceleration used with multiply
    instanced moving objects.</li>
  <li>For integrated versions of mental ray: fixed possible crash at
    <em>aborting</em> of the rendering for large scenes which did not fit
    into the memory completely and triggered database flushing. The crash was
    more likely with BSP2 acceleration used.</li>
  <li>In some cases when using the rasterizer with shutter_delay &gt; 0, with
    motion on, and samples_motion &gt; 1, incorrect motion could be
    calculated. Fixed.</li>
  <li>In the subdivision surface compatibility mode (enabled with
    <code>MI_SURF_CCMESH</code> environment variable), fixed broken motion
    vectors for multi-segment motion.</li>
  <li>For scenes with camera motion and scanline mode off, fixed missing
    motion blur regression from version 3.7.1.1.</li>
  <li>Platform specific: on Linux and MacOSX, fixed possible freeze for very
    long rendering sessions occurring after 4 billion of database creation
    and editing operations.</li>
  <li>Platform specific: on Windows, fixed a bug in rayserver service causing
    possible connection failures.</li>
</ul>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>Changed default value for importon density used in combination with
    Irradiance Particles. The new value is <code>0.1</code> (per pixel). In
    combination with photons, the old default value of 1 is still used. </li>
</ul>

<p><strong>Shader changes:</strong></p>
<ul>
  <li>For the <code>mip_render_subset</code> production shader, fixed
    possible wrong subset of geometry rendered in the finalgather
    precomputing mode.</li>
  <li>Fixed rendering with <code>mip_motionblur</code> and
    <code>mip_motion_vector</code> production shaders used with orthographic
    camera.</li>
  <li>For the production shaders <code>mip_mirrorball</code> and
    <code>mip_greyball</code>, fixed possible crash with non-zero blur and no
    texture attached. </li>
  <li>For production <code>mip_binaryproxy</code> shader, the amount of
    displacement has not been taken into account for bounding box
    computation, fixed.</li>
  <li>For the architectural material library,transparent portal lights have
    been fixed to not show up in the Z buffer anymore.</li>
  <li>The physical "<code>transmat</code>" shader did not support segment
    shadow mode. Fixed.</li>
</ul>

<h3>Changes in Version 3.7.1.1</h3>

<p><strong>New features:</strong></p>
<ul>
  <li>Hair approximation. In addition to the old approximation syntax which
    directly specifies the number of approximating segments, it is now
    possible to specify adaptive length, distance, angle approximation
    including view-dependent approximations. Parametric approximations
    depending on the degree of the hair curves are supported as well. 
    <p>Especially for curved hair and hair at higher viewing distance, the
    new approximation criterion allows to have high approximation resolution
    restricted to the area where needed. The lower number of hair segments
    result in reduced memory consumption and increase rendering speed.</p>
    <p>The approximation can be specified on a hair object with the following
    syntax:</p>
    <p><code>approximate hair &lt;curve_approx&gt;</code></p>
    <p>with <code>&lt;curve_approx</code>&gt; being any curve approximation
    technique, for example:</p>
    <p><code>approximate hair view length 3 distance 0.1 angle 5 0
    7</code></p>
    <p>In order to get benefit from curvature-dependent approximations, hair
    needs to be modelled appropriately with hair degree &gt; 1.</p>
  </li>
  <li>For moving polygonal objects with displacement, added functionality to
    <strong>automatically control</strong> the quality of
    <strong>displacement according to the amount of visual motion</strong>. 
    <p>For fast moving objects, images with comparable visual quality may be
    achieved with fewer displacement tessellation details compared to static
    or slow moving objects. Though it is also possible to tweak displacement
    approximation on a per-object basis, this requires a lot of manual
    efforts and is rarely done in practice. Per-object granularity may also
    be not fine enough for object having different amount of motion in
    different parts. The new approximation motion factor provides an
    automatic way for adjusting the displacement quality according to the
    amount of motion for a given object part.</p>
    <p>For view-dependent fine poky displacement the adaptive subdivision
    checks motion length in screen space. The measured motion length is used
    to modify the use of the approximation constant. Geometry is reduced only
    in areas of the object with strong motion.</p>
    <p>The string option<code>"geom displace motion factor" f</code> can be
    used to modify the amount of geometry reduction compared to static case,
    with float <code>f &gt;= 0</code>. The factor <code>f=0</code> turns off
    the feature. The factor <code>f=1</code> is currently the default, and
    gives higher values of <code>f</code> give more reduction. This default
    value is <em><strong>experimental</strong></em> and is rather
    conservative: the simplification of geometry will have an effect for
    motion of approximately 16 pixels. In order to get effect on slower
    motion, higher values should be used. For example, the factor value of 8
    would reduce geometry in areas of objects moving at the speed of 2 pixels
    per frame.</p>
  </li>
  <li><em><strong>Experimental: </strong></em> In mental ray 3.6/3.6+ the
    only object-size independent approximation technique is the angle-base
    approximation which in some cases does not result in performance-optimal
    meshes. A new distance-ratio based approximation technique has been
    implemented, which is driven by the approximation error along an edge and
    the length of the edge. 
    <p>In the current version, it can be enabled by setting the environment
    variable <code><strong>MI_DISTANCE_RATIO</strong></code> and using the
    distance approximation technique. Recommended values are of order 0.02,
    with finer approximations corresponding to smaller values.</p>
  </li>
</ul>

<p><strong>Feature improvements:</strong></p>
<ul>
  <li>Significant algorithmic changes have been applied to the BSP2
    acceleration construction: 
    <ul>
      <li>for the scenes with motion blur, the construction time has been
        decreased dramatically</li>
      <li>for static scenes, memory required for the construction has been
        reduced and the construction time significantly decreased</li>
      <li>for both static and motion BSP2 trees, the quality of the
        constructed trees has been improved significantly, resulting in the
        performance improvements of the intersection tests.</li>
    </ul>
  </li>
  <li>Irradiance Particles have been extended with IBL-style functionality
    which can be enabled with the string options "irradiance particles
    indirect passes" is set to -1. 
    <p>If Irradiance Particles interpolation is disabled then only
    environment presampling map is build and no further precomputation steps
    are required.</p>
    <p>If Irradiance particles Interpolation is enabled, then particles are
    emitted in the precomputation pass in a usual way, but used as
    interpolation points only.</p>
    <p>In both cases, only the environment map lighting but not diffuse
    bounces are taken into account.</p>
  </li>
  <li>For the detailed shadow maps saved to a file: render and store all
    shadowmap tiles (not just actually used ones).</li>
  <li>The OpenEXR version as been updated to 1.6.1.</li>
</ul>

<p><strong>Bug fixes:</strong></p>
<ul>
  <li>For Irradiance Particles, contribution of the environment was off by
    factor PI, fixed.</li>
  <li>For volume shaders used in segmented shadow mode with autovolume turned
    off, added missing call of the volume shader for the last segment (one
    between the last occluder and the light).</li>
  <li>For standalone version of mental ray, fixed wrong number of licensed
    used by machines with hyperthreaded CPUs if the number of licenses was
    specified as a command line parameter. 
    <p></p>
  </li>
</ul>

<p><strong>Changes affecting compatibility with older versions:</strong></p>
<ul>
  <li>mental ray 3.7 code has been switched to use STLPORT compiled in the
    proprietary namespace MISTD. This resolves potential symbol conflicts for
    integrating application and 3rd party plugins; requirements on the
    compiler compatibility / version match are reduced.</li>
  <li>OpenEXR library is linked statically. On an attempt to link
    <code>mi_openexr.dll</code>, a warning message is printed.</li>
  <li>Removed obsolete syntax and API interface for implicit patches.</li>
  <li>Removed obsolete box type from the <code>miGeoBox</code> structure.</li>
  <li><code>miMaterial</code> structure has been extended with bsdf slot.</li>
  <li>The layout of <code>miHair_list</code> structure has been extended with
    approximation. Unused integer approximation has been removed.</li>
  <li>Map containers have been added to the
    <code>mi::shader::Interface</code> class. 
    <p></p>
  </li>
</ul>

<h2 id="openexr">Support for OpenEXR</h2>

<p>OpenEXR is a flexible image format designed by Industrial Light &amp;
Magic, which has been integrated in mental ray 3.3.0.389 and later versions.
OpenEXR comes with the following copyright, which applies only to the OpenEXR
portion of mental ray:</p>

<p>Copyright &copy; 2004, Industrial Light &amp; Magic, a division of
Lucasfilm Entertainment Company Ltd. Portions contributed and copyright held
by others as indicated. All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:</p>
<ul>
  <li>Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.</li>
  <li>Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.</li>
  <li>Neither the name of Industrial Light &amp; Magic nor the names of its
    contributors may be used to endorse or promote products derived from this
    software without specific prior written permission.</li>
</ul>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS
IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>
<!--BEGIN_PXR24_CODEC-->

<p>The ``Pxr24'' compression in OpenEXR comes with the following copyright,
which apples only to parts of the OpenEXR portion of mental ray:</p>

<p>Copyright &copy; 2004, Pixar Animation Studios</p>

<p>All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:</p>
<ul>
  <li>Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.</li>
  <li>Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.</li>
  <li>Neither the name of Pixar Animation Studios nor the names of its
    contributors may be used to endorse or promote products derived from this
    software without specific prior written permission.</li>
</ul>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS
IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>
<!--END_PXR24_CODEC-->

<p id="copyright"><span class="copyright"><b>Copyright
Information</b></span></p>

<p>Copyright &copy; 1986-2010 mental images GmbH, Berlin, Germany.</p>

<p>All rights reserved.</p>

<p>This document contains proprietary and confidential information of mental
images GmbH and is protected under copyright law. The contents of this
document may not be disclosed to third parties, translated, copied or
duplicated in any form, in whole or in part, without the express written
permission of mental images GmbH.</p>

<p>The information contained in this document is subject to change without
notice. Neither mental images GmbH nor its employees shall be responsible for
incidental or consequential damages resulting from the use of this material
or liable for technical or editorial omissions made herein.</p>

<p>mental images&reg;, mental ray&reg;, mental matter&reg;, mental mill&reg;,
mental queue&trade;, mental world&trade;, mental map&trade;, mental
earth&trade;, mental cloud&trade;, mental mesh&reg;, mental&trade;,
Reality&trade;, RealityServer&reg;, RealityPlayer&reg;, RealityDesigner&reg;,
MetaSL&reg;, Meta&trade;, Metanode&reg;, Phenomenon&trade;, Phenomena&trade;,
Phenomenon Creator&reg;, Phenomenon Editor&reg;, neuray&reg;, iray&reg;,
DiCE&trade;, imatter&reg;, Shape-By-Shading&reg;, SPM&reg;, and rendering
imagination visible&trade; are trademarks or, in some countries, registered
trademarks of mental images GmbH, Berlin, Germany.</p>

<p>All other product names mentioned in this document may be trademarks or
registered trademarks of their respective owners and are hereby
acknowledged.</p>
<!--
<P>This product is manufactured under one or more of the following patents:
United States (US) No. 6,496,190, No. 6,529,193, No. 6,606,092; Australia
(AU) No. 731,641, No. 744,983, No. 752,048, No. 759,796; France (F) No.
099&nbsp;2024; Germany (D) No. 6981&nbsp;2947.4; United Kingdom (UK)
No. 099&nbsp;2024; Patents Pending.
-->
<hr class="copyright" size="1">
</body>
</html>
